var A=Object.create;var f=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var I=Object.getOwnPropertyNames;var q=Object.getPrototypeOf,L=Object.prototype.hasOwnProperty;var v=r=>f(r,"__esModule",{value:!0});var N=(r,e)=>{for(var o in e)f(r,o,{get:e[o],enumerable:!0})},S=(r,e,o,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of I(e))!L.call(r,i)&&(o||i!=="default")&&f(r,i,{get:()=>e[i],enumerable:!(t=k(e,i))||t.enumerable});return r},p=(r,e)=>S(v(f(r!=null?A(q(r)):{},"default",!e&&r&&r.__esModule?{get:()=>r.default,enumerable:!0}:{value:r,enumerable:!0})),r),j=(r=>(e,o)=>r&&r.get(e)||(o=S(v({}),e,1),r&&r.set(e,o),o))(typeof WeakMap!="undefined"?new WeakMap:0);var a=(r,e,o)=>new Promise((t,i)=>{var l=n=>{try{c(o.next(n))}catch(s){i(s)}},d=n=>{try{c(o.throw(n))}catch(s){i(s)}},c=n=>n.done?t(n.value):Promise.resolve(n.value).then(l,d);c((o=o.apply(r,e)).next())});var D={};N(D,{parseQuery:()=>W,query:()=>B});var h=p(require("path"),1),y=p(require("os"),1),m=p(require("fs"),1),O=require("child_process");var x=require("@aws-sdk/credential-providers"),E=require("@aws-sdk/client-s3"),g=r=>(0,x.fromIni)({profile:r,mfaCodeProvider:e=>a(void 0,null,function*(){return e})});function w(r){return new E.S3Client(r)}var b=p(require("util"),1),C=b.default.promisify(O.exec),R=(0,h.join)(process.cwd(),"node_modules",".bin","mlr@v6.0.0"),T=class{constructor(e){this.name=e.name!==""?e.name:h.default.basename(e.source),this.options=e,this.env="local",this.createdAt=new Date,this.state="init",this.connector=null,this.loader=null,this.metadata={type:"",columns:[],header:!1,extension:"",size:0,rowCount:0,spanMultipleLines:!1,quotes:!1,delimiter:",",errors:{},warnings:{}}}rowCount(){return a(this,null,function*(){let e=yield C(`${R} --ojson count ${this.options.source}`);if(e.stderr!=="")throw new Error(`failed-to-get-row-count: ${e.stderr}`);let o=JSON.parse(e.stdout);if(o.length===0)throw new Error("failed-to-get-row-count: no rows found");if(o[0].count===void 0)throw new Error("failed-to-get-row-count: no count found");this.metadata.rowCount=o[0].count})}headerColumn(){return a(this,null,function*(){let e=yield C(`${R} --icsv --ojson head -n 1 ${this.options.source}`);if(e.stderr!=="")throw new Error(`failed-to-get-header-column: ${e.stderr}`);console.log(e);let o=JSON.parse(e.stdout);if(o.length===0)throw new Error("failed-to-get-header-column: no columns found");this.metadata.columns=Object.keys(o[0])})}fileType(){return a(this,null,function*(){if(y.default.platform()!=="linux"&&y.default.platform()!=="darwin")throw new Error("unsupported-platform");let e=yield C(`file ${this.options.source} --mime-type`);if(e.stderr!=="")throw new Error(`failed-to-detect-mime-type: ${e.stderr}`);let o=e.stdout.split(":")[1].trim();if(o==="")throw new Error("failed-to-detect-mime-type");this.options.source.endsWith(".csv")&&(this.metadata.extension="csv"),this.options.source.endsWith(".json")&&(this.metadata.extension="json"),this.metadata.type=o})}fileSize(){return a(this,null,function*(){let e=yield m.default.promises.stat(this.options.source);this.metadata.size=e.size})}determineLoader(){if(this.options.destination.startsWith("s3://")){this.loader=w({credentials:g("default"),region:"us-east-2"});return}if(this.options.source.startsWith("/")||this.options.source.startsWith("../")||this.options.source.startsWith("./")){this.loader=m.default.createWriteStream(this.options.destination);return}throw new Error("unsupported-loader")}determineConnector(){if(this.options.source.startsWith("/")||this.options.source.startsWith("../")||this.options.source.startsWith("./")){if(!m.default.existsSync(this.options.source))throw new Error(`file: ${this.options.source} not found, please provide a valid file path`);this.connector=m.default.createReadStream(this.options.source);return}if(this.options.source.startsWith("s3://")){this.connector=w({credentials:g("default"),region:"us-east-2"});return}throw new Error(`unsupported-source for: ${this.options.source}`)}};function $(r,e){return a(this,null,function*(){return yield new Promise((o,t)=>{(e.source===""||e.source===void 0)&&t(new Error("failed-to-create-catalog: no source provided")),(e.destination===""||e.destination===void 0)&&t(new Error("failed-to-create-catalog: no destination provided")),(e.name===""||e.name===void 0)&&t(new Error("failed-to-create-catalog: no name provided")),e.input==="csv"&&!e.source.endsWith(".csv")&&t(new Error("failed-to-create-catalog: file extension does not match input type")),e.input==="json"&&!e.source.endsWith(".json")&&t(new Error("failed-to-create-catalog: file extension does not match input type"));let i=new T(e);Promise.all([i.determineLoader(),i.determineConnector(),i.headerColumn(),i.fileSize(),i.fileType(),i.rowCount()]).then(()=>{console.log(`created catalog for: ${e.name}`),o(i)}).catch(l=>t(l))})})}var P=require("pgsql-parser"),_=class{constructor(){this.query="",this.stmt={type:"",distinct:!1,columns:[{name:"",type:""}],from:[{schemaname:"",relname:"",inh:""}],sort:{},where:{},group:[],having:[],orderBy:[],limit:{type:"",val:""}}}parse(e){var l,d,c;if(e.trim()==="")throw new Error("invalid-query: no query found");console.log(`raw: ${e}`);let o=(0,P.parse)(e);Object.keys(o[0].RawStmt.stmt)[0]==="SelectStmt"&&(this.stmt.type="select");let t=o[0].RawStmt.stmt.SelectStmt,i=t.limitOption;if(i==="LIMIT_OPTION_DEFAULT"&&(this.stmt.limit={type:t.limitOption,val:""}),i==="LIMIT_OPTION_COUNT"&&t.limitCount!==""&&(this.stmt.limit={type:t.limitOption,val:t.limitCount.A_Const.val.Integer.ival}),t.distinctClause!==void 0&&(this.stmt.distinct=!0),t.targetList!==void 0&&(this.stmt.columns=t.targetList.map(n=>{let s=n.ResTarget.val.ColumnRef.fields[0];return s.A_Star!==void 0?{name:"*"}:{name:s.String.str}})),this.stmt.from=t.fromClause.map(n=>{let s={schemaname:"",relname:"",inh:""},u=n.RangeVar;return u.schemaname!==void 0&&(s.schemaname=u.schemaname),u.relname!==void 0&&(s.relname=u.relname),u.inh!==void 0&&(s.inh=u.inh),s}),t.whereClause!==void 0){if(t.whereClause!==null&&((l=t==null?void 0:t.whereClause)==null?void 0:l.A_Expr.kind)==="AEXPR_OP"){let n=t.whereClause.A_Expr,s={operator:"",left:{},right:{}};s.operator=n.name[0].String.str,n.lexpr!==null&&(s.left=n.lexpr.ColumnRef.fields[0].String.str),n.rexpr!==null&&(s.right=n.rexpr.ColumnRef.fields[0].String.str),this.stmt.where=s}if(((d=t==null?void 0:t.whereClause)==null?void 0:d.A_Expr)!==null&&((c=t==null?void 0:t.whereClause)==null?void 0:c.A_Expr.kind)==="AEXPR_IN"){let n=t.whereClause.A_Expr;console.log(n)}if(t.whereClause.BoolExpr!==null){if(t.whereClause.BoolExpr.boolop==="AND_EXPR"){let n=t.whereClause.BoolExpr.args;console.log(JSON.stringify(n,null,2))}if(t.whereClause.BoolExpr.boolop==="OR_EXPR"){let n=t.whereClause.BoolExpr.args;console.log(JSON.stringify(n,null,2))}}}return this.stmt}};function W(r){return new _().parse(r)}function B(r,e){return a(this,null,function*(){let o=yield $(r,e);console.log(o)})}module.exports=j(D);0&&(module.exports={parseQuery,query});
