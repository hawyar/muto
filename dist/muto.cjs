var k=Object.create;var d=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var N=Object.getPrototypeOf,F=Object.prototype.hasOwnProperty;var W=(i,t)=>{for(var r in t)d(i,r,{get:t[r],enumerable:!0})},x=(i,t,r,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of L(t))!F.call(i,s)&&s!==r&&d(i,s,{get:()=>t[s],enumerable:!(e=B(t,s))||e.enumerable});return i};var f=(i,t,r)=>(r=i!=null?k(N(i)):{},x(t||!i||!i.__esModule?d(r,"default",{value:i,enumerable:!0}):r,i)),X=i=>x(d({},"__esModule",{value:!0}),i);var u=(i,t,r)=>new Promise((e,s)=>{var n=o=>{try{a(r.next(o))}catch(c){s(c)}},l=o=>{try{a(r.throw(o))}catch(c){s(c)}},a=o=>o.done?e(o.value):Promise.resolve(o.value).then(n,l);a((r=r.apply(i,t)).next())});var J={};W(J,{createCatalog:()=>S,parser:()=>E,query:()=>H});module.exports=X(J);var p=f(require("path"),1),A=require("readline"),C=f(require("os"),1),y=require("fs"),_=require("child_process"),M=f(require("util"),1),h=require("fs/promises");var b=f(require("is-installed-globally"),1),g=require("path"),v=require("process"),O=require("fs"),P=require("child_process"),j=class{constructor(){this.version="6.0.0",this.path=(0,g.join)((0,v.cwd)(),"node_modules",".bin","mlr@v"+this.version),this.args=[]}getCmd(){return this.path}getArgs(){return this.args}getPath(){if(this.path==="")throw new Error("miller-path-not-set: missing miller binary path");return this.path}fileSource(t){if(this.args.length===0)throw new Error("First specifiy the arguments then add the source file");return this.args.push(t),this}csvInput(){return this.args.push("--icsv"),this}jsonInput(){return this.args.push("--ijson"),this}csvOutput(){return this.args.push("--ocsv"),this}jsonOutput(){return this.args.push("--ojson"),this}implicitCsvHeader(t){return this.args.push(`--implicit-csv-header label ${t.join(",")}`),this}count(){return this.args.push("count"),this}cat(){return this.args.push("cat"),this}cut(t){return this.args.push(`cut -o -f ${t.join(",")}`),this}head(t){return this.args.push(`head -n ${t}`),this}determinePath(){if(b.default){let t=(0,P.execSync)("npm root -g");if(t===null)throw new Error("Failed to find global miller path");let r=(0,g.join)(t.toString().trim(),"muto","node_modules",".bin","mlr@"+this.version);(0,O.existsSync)(r)&&(this.path=r);return}this.path===""&&(this.path=(0,g.join)((0,v.cwd)(),"node_modules",".bin","mlr@"+this.version))}};function m(){let i=new j;return i.determinePath(),i}var w=M.default.promisify(_.exec),R=class{constructor(t){this.options=t,this.createdAt=new Date,this.source={path:{root:"",dir:"",base:"",ext:"",name:""},type:"csv",columns:[],header:!1,fileSize:0,rowCount:0,spanMultipleLines:!1,quotes:!1,delimiter:",",errors:{},warnings:{},preview:[]},this.destination={path:{root:"",dir:"",base:"",ext:"",name:""},type:"csv",columns:[],header:!1,fileSize:0,rowCount:0,spanMultipleLines:!1,quotes:!1,delimiter:",",errors:{},warnings:{},preview:[]}}getSource(){return this.source}getDestination(){return this.destination}getOptions(){return this.options}getColumns(){return this.source.columns}rowCount(){return u(this,null,function*(){let t=m(),r=t.getCmd()+" "+t.jsonOutput().count().fileSource(this.options.source).getArgs().join(" "),e=yield w(r);if(e.stderr!=="")throw new Error(`failed-to-get-row-count: ${e.stderr}`);let s=JSON.parse(e.stdout);if(s.length===0)throw new Error("failed-to-get-row-count: no rows found");if(s[0].count===void 0)throw new Error("failed-to-get-row-count: no count found");this.source.rowCount=s[0].count})}columnHeader(){return u(this,null,function*(){let t=m(),r=t.getCmd()+" "+t.jsonOutput().head(1).fileSource(this.options.source).getArgs().join(" "),e=yield w(r);if(e.stderr!=="")throw new Error(`failed-to-get-header-column: ${e.stderr}`);let s=JSON.parse(e.stdout);if(s.length===0)throw new Error("failed-to-get-header-column: no columns found");for(let n in s[0])this.source.columns.push(s[0][n]);this.source.header=!0})}validateSource(){return u(this,null,function*(){let t=yield(0,h.stat)(this.options.source);if(!t.isFile())throw Error("Source path is not a file");if(yield(0,h.access)(this.options.source,y.constants.R_OK).catch(()=>{throw Error("Source file is not readable")}),t.size===0)throw Error("Source file is empty");this.source.path=p.default.parse(this.options.source)})}validateDestination(){return u(this,null,function*(){this.destination.path=p.default.parse(this.options.destination)})}fileType(){return u(this,null,function*(){if(C.default.platform()!=="linux"&&C.default.platform()!=="darwin")throw new Error("unsupported-platform");let{stdout:t,stderr:r}=yield w(`file ${this.options.source} --mime-type`);if(r!=="")throw new Error(`failed-to-detect-mime-type: ${r}`);let e=t.split(":")[1].trim();if(e==="application/json")throw new Error("failed-to-detect-mime-type");if(e==="application/csv"){this.source.type="csv";return}if(e==="application/json"){this.source.type="json";return}if(e==="text/csv"){this.source.type="csv";return}if(e==="text/plain"){this.source.type="csv";return}let s=(0,A.createInterface)({input:(0,y.createReadStream)(this.options.source)}),n="";throw s.on("line",l=>{n=l,s.close()}),s.on("close",()=>{if(n.startsWith("{")||n.startsWith("["))return!0;if(this.options.delimiter===void 0&&n.split(this.options.delimiter).length===this.source.columns.length)return this.source.type="csv",!0;throw new Error("failed-to-detect-mime-type")}),Error(`Unsupported file type ${e}`)})}fileSize(){return u(this,null,function*(){let t=yield(0,h.stat)(this.options.source);this.source.fileSize=t.size})}sanitizeColumnNames(t){return t.map(r=>r.replace(/[^a-zA-Z0-9]/g,"_"))}preview(){return u(this,null,function*(){let t=m(),r=t.getCmd()+t.jsonOutput().head(5).fileSource(this.options.source).getArgs().join(" "),e=yield w(r);if(e.stderr!=="")throw new Error(e.stderr);let s=JSON.parse(e.stdout);if(s.length===0)throw new Error("failed-to-get-preview: no rows found");this.source.preview=s})}};function S(i){return u(this,null,function*(){return yield new Promise((t,r)=>{i===void 0&&r(new Error("missing-catalog-options")),(i.source===void 0||i.source==="")&&r(new Error("failed-to-create-catalog: no source provided")),(i.destination===void 0||i.destination==="")&&r(new Error("failed-to-create-catalog: no destination provided"));let e=Object.assign({},i);if(i.input===void 0)switch(p.default.extname(i.source)){case".csv":e.input="csv";break;case".json":e.input="json";break;default:r(new Error("failed-to-create-catalog: unsupported input file type"))}if(i.output===void 0)switch(p.default.extname(i.destination)){case".csv":e.output="csv";break;case".json":e.output="json";break;default:r(new Error("failed-to-create-catalog: unsupported output file type"))}let s=new R(e);Promise.all([s.validateSource(),s.validateDestination(),s.columnHeader(),s.fileSize(),s.fileType(),s.rowCount()]).then(()=>{console.log(`created catalog ${s.getSource().path.name}`),t(s)}).catch(n=>r(n))})})}var T=class{constructor(t,r){this.stmt=r,this.catalog=t,this.plan={cmd:"",args:[]}}analyze(){let t=m();if(this.plan.cmd=t.getPath(),this.stmt.type!=="select")throw Error("Only select queries are supported at this time");if(this.stmt.from.length!==1)throw Error("Multi-table queries are not supported");let r=this.stmt.from[0].relname;console.log("table:",r);let e=this.catalog.options.source;if(this.stmt.columns.length===1){if(this.stmt.columns[0].name==="*")return console.log("columns: *"),this.plan.args=t.csvInput().jsonOutput().cat().fileSource(e).getArgs(),this.plan;let s=this.stmt.columns[0].name.replace(/[^a-zA-Z0-9]/g,"_");if(!this.catalog.source.columns.includes(s))throw new Error(`Column not found,  ${s}`);return console.log("column:",this.stmt.columns[0].name),this.plan.args=t.csvInput().jsonOutput().cut([this.stmt.columns[0].name]).fileSource(e).getArgs(),this.plan}if(this.stmt.columns.length>1){let s=this.stmt.columns.map(n=>{let l=n.name.replace(/[^a-zA-Z0-9]/g,"_");if(!this.catalog.source.columns.includes(l))throw new Error(`column ${n.name} is not in the list of columns`);return l}).join(",");return this.plan.args=["--icsv","--ojson","--implicit-csv-header","label",`${this.catalog.source.columns.join(",")}`,"then","cut","-o","-f",s,e],this.plan}throw Error("Error: no columns specified")}};function q(i,t){return new T(i,t).analyze()}var z=require("pgsql-parser"),I=class{constructor(t){this.query=t,this.stmt={type:"",distinct:!1,columns:[{name:"",type:""}],from:[{schemaname:"",relname:"",inh:""}],sort:{},where:{operator:"",left:"",right:""},groupBy:[],having:[],orderBy:[],limit:{type:"",val:""}}}getStmt(){return this.stmt}getColumns(){return this.stmt.columns.map(t=>t.name)}isDistinct(){return this.stmt.distinct}getWhere(){return this.stmt.where}limit(){return parseInt(this.stmt.limit.val)}getTable(){return this.stmt.from[0].relname}getType(){return this.stmt.type}getGroupBy(){return this.stmt.groupBy}parse(){var n,l;let t=this.query;if(t.trim()==="")throw new Error("invalid-query: no query found");let r=(0,z.parse)(t);Object.keys(r[0].RawStmt.stmt)[0]==="SelectStmt"&&(this.stmt.type="select");let e=r[0].RawStmt.stmt.SelectStmt,s=e.limitOption;if(s==="LIMIT_OPTION_DEFAULT"&&(this.stmt.limit={type:e.limitOption,val:""}),s==="LIMIT_OPTION_COUNT"&&e.limitCount!==""&&(this.stmt.limit={type:e.limitOption,val:e.limitCount.A_Const.val.Integer.ival}),e.distinctClause!==void 0&&(this.stmt.distinct=!0),e.targetList!==void 0&&(this.stmt.columns=e.targetList.map(a=>{let o=a.ResTarget.val.ColumnRef.fields[0];return o.A_Star!==void 0?{name:"*"}:{name:o.String.str}})),e.fromClause!==void 0&&(this.stmt.from=e.fromClause.map(a=>{let o={schemaname:"",relname:"",inh:""},c=a.RangeVar;return c.schemaname!==void 0&&(o.schemaname=c.schemaname),c.relname!==void 0&&(o.relname=c.relname),c.inh!==void 0&&(o.inh=c.inh),o})),e.groupClause!==void 0){let a=e.groupClause.map(o=>o.ColumnRef.fields[0].String.str);this.stmt.groupBy=a}if(e.whereClause!==void 0){if(e.whereClause!==null&&((n=e==null?void 0:e.whereClause)==null?void 0:n.A_Expr.kind)==="AEXPR_OP"){let a=e.whereClause.A_Expr,o={operator:"",left:"",right:""};o.operator=a.name[0].String.str,a.lexpr!==void 0&&(o.left=a.lexpr.ColumnRef.fields[0].String.str),a.rexpr!==void 0&&(a.rexpr.ColumnRef!==void 0&&Object.keys(a.rexpr.ColumnRef.fields[0]).includes("String")&&(o.right=a.rexpr.ColumnRef.fields[0].String.str),a.rexpr.A_Const!==void 0&&(o.right=a.rexpr.A_Const.val.Integer.ival)),this.stmt.where=o}e.whereClause.A_Expr!==void 0&&((l=e==null?void 0:e.whereClause)==null||l.A_Expr.kind),e.whereClause.BoolExpr!==void 0&&(e.whereClause.BoolExpr.boolop,e.whereClause.BoolExpr.boolop)}return this.stmt}};function E(i){let t=new I(i);return t.parse(),t}var D=require("child_process"),$=require("fs");function H(i,t){return u(this,null,function*(){if(i===void 0||i==="")throw new Error("No query provided");let r=E(i);if(r.getType()!=="select")throw new Error("Only select queries are supported at this time");let e=yield S(t),s=q(e,r.getStmt());console.log("mlr "+s.args.join(" "));let n=(0,D.spawn)(s.cmd,s.args);if(n.on("error",l=>{console.error(l)}),n.stdout===null)throw new Error("stdout is null");n.stdout.on("close",()=>{if(t.onEnd!==void 0){t.onEnd();return}console.log("\u2713 query complete ")}),n.stdout.pipe((0,$.createWriteStream)(t.destination))})}0&&(module.exports={createCatalog,parser,query});
