var $=Object.create;var p=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var W=Object.getPrototypeOf,B=Object.prototype.hasOwnProperty;var F=(i,t)=>{for(var r in t)p(i,r,{get:t[r],enumerable:!0})},x=(i,t,r,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of L(t))!B.call(i,s)&&s!==r&&p(i,s,{get:()=>t[s],enumerable:!(e=k(t,s))||e.enumerable});return i};var d=(i,t,r)=>(r=i!=null?$(W(i)):{},x(t||!i||!i.__esModule?p(r,"default",{value:i,enumerable:!0}):r,i)),H=i=>x(p({},"__esModule",{value:!0}),i);var u=(i,t,r)=>new Promise((e,s)=>{var a=n=>{try{o(r.next(n))}catch(l){s(l)}},m=n=>{try{o(r.throw(n))}catch(l){s(l)}},o=n=>n.done?e(n.value):Promise.resolve(n.value).then(a,m);o((r=r.apply(i,t)).next())});var U={};F(U,{createCatalog:()=>E,parser:()=>S,query:()=>X});module.exports=H(U);var g=d(require("path"),1),_=require("readline"),v=d(require("os"),1),w=require("fs"),j=require("child_process"),M=d(require("util"),1),h=require("fs/promises");var b=d(require("is-installed-globally"),1),f=require("path"),y=require("process"),O=require("fs"),P=require("child_process"),A=class{constructor(){this.version="6.0.0",this.path=(0,f.join)((0,y.cwd)(),"node_modules",".bin","mlr@v"+this.version),this.args=[]}getCmd(){return this.path}getArgs(){return this.args}getPath(){if(this.path==="")throw new Error("miller-path-not-set: missing miller binary path");return this.path}fileSource(t){if(this.args.length===0)throw new Error("First specifiy the arguments then add the source file");return this.args.push(t),this}csvInput(){return this.args.push("--icsv"),this}jsonInput(){return this.args.push("--ijson"),this}csvOutput(){return this.args.push("--ocsv"),this}jsonOutput(){return this.args.push("--ojson"),this}implicitCsvHeader(t){return this.args.push(`--implicit-csv-header label ${t.join(",")}`),this}count(){return this.args.push("count"),this}cat(){return this.args.push("cat"),this}head(t){return this.args.push(`head -n ${t}`),this}determinePath(){if(b.default){let t=(0,P.execSync)("npm root -g");if(t===null)throw new Error("Failed to find global miller path");let r=(0,f.join)(t.toString().trim(),"muto","node_modules",".bin","mlr@"+this.version);(0,O.existsSync)(r)&&(this.path=r);return}this.path===""&&(this.path=(0,f.join)((0,y.cwd)(),"node_modules",".bin","mlr@"+this.version))}};function c(){let i=new A;return i.determinePath(),i}var C=M.default.promisify(j.exec),R=class{constructor(t){this.options=t,this.createdAt=new Date,this.metadata={root:process.cwd(),dir:"",base:"",ext:"",fileName:"",type:"csv",columns:[],header:!1,filesize:0,rowCount:0,spanMultipleLines:!1,quotes:!1,delimiter:",",errors:{},warnings:{}}}getSource(){return this.options.source}getDestination(){return this.options.destination}getOptions(){return this.options}getMetadata(){return this.metadata}getColumns(){return this.metadata.columns}rowCount(){return u(this,null,function*(){let t=c(),r=t.getCmd()+" "+t.jsonOutput().count().fileSource(this.getSource()).getArgs().join(" "),e=yield C(r);if(e.stderr!=="")throw new Error(`failed-to-get-row-count: ${e.stderr}`);let s=JSON.parse(e.stdout);if(s.length===0)throw new Error("failed-to-get-row-count: no rows found");if(s[0].count===void 0)throw new Error("failed-to-get-row-count: no count found");this.metadata.rowCount=s[0].count})}columnHeader(){return u(this,null,function*(){let t=c(),r=t.getCmd()+" "+t.jsonOutput().head(1).fileSource(this.options.source).getArgs().join(" "),e=yield C(r);if(e.stderr!=="")throw new Error(`failed-to-get-header-column: ${e.stderr}`);let s=JSON.parse(e.stdout);if(s.length===0)throw new Error("failed-to-get-header-column: no columns found");for(let a in s[0])this.metadata.columns.push(s[0][a]);this.metadata.header=!0})}validateSource(){return u(this,null,function*(){let t=yield(0,h.stat)(this.options.source);if(!t.isFile())throw Error("Source path is not a file");if(yield(0,h.access)(this.options.source,w.constants.R_OK).catch(()=>{throw Error("Source file is not readable")}),t.size===0)throw Error("Source file is empty");let r=g.default.parse(this.options.source);this.metadata.dir=r.dir,this.metadata.base=r.base,this.metadata.ext=r.ext,this.metadata.fileName=r.name})}fileType(){return u(this,null,function*(){if(v.default.platform()!=="linux"&&v.default.platform()!=="darwin")throw new Error("unsupported-platform");let t=yield C(`file ${this.options.source} --mime-type`);if(t.stderr!=="")throw new Error(`failed-to-detect-mime-type: ${t.stderr}`);let r=t.stdout.split(":")[1].trim();if(r==="")throw new Error("failed-to-detect-mime-type");if(r==="text/csv"){this.metadata.type="csv";return}if(r==="application/json"){this.metadata.type="json";return}let e=(0,_.createInterface)({input:(0,w.createReadStream)(this.options.source)}),s="";throw e.on("line",a=>{s=a,e.close()}),e.on("close",()=>{if(s.startsWith("{")||s.startsWith("["))return this.metadata.type="json",!0;if(s.startsWith('"')||s.startsWith("'"))return this.metadata.type="csv",!0}),Error(`Error: Unsupported file type ${r}`)})}fileSize(){return u(this,null,function*(){let t=yield(0,h.stat)(this.options.source);this.metadata.filesize=t.size})}sanitizeColumnNames(t){return t.map(r=>r.replace(/[^a-zA-Z0-9]/g,"_"))}};function E(i){return u(this,null,function*(){return yield new Promise((t,r)=>{i===void 0&&r(new Error("missing-catalog-options")),(i.source===void 0||i.source==="")&&r(new Error("failed-to-create-catalog: no source provided")),(i.destination===void 0||i.destination==="")&&r(new Error("failed-to-create-catalog: no destination provided"));let e=Object.assign({},i);if(i.input===void 0)switch(g.default.extname(i.source)){case".csv":e.input="csv";break;case".json":e.input="json";break;default:r(new Error("failed-to-create-catalog: unsupported input file type"))}if(i.output===void 0)switch(g.default.extname(i.destination)){case".csv":e.output="csv";break;case".json":e.output="json";break;default:r(new Error("failed-to-create-catalog: unsupported output file type"))}let s=new R(e);Promise.all([s.validateSource(),s.columnHeader(),s.fileSize(),s.fileType(),s.rowCount()]).then(()=>{console.log(`created catalog ${s.getMetadata().fileName}`),t(s)}).catch(a=>r(a))})})}var T=class{constructor(t,r){this.stmt=r,this.catalog=t,this.plan={cmd:"",args:[]}}analyze(){console.log("analyzing query:");let t=c();if(this.plan.cmd=t.getPath(),this.stmt.type!=="select")throw Error("Only select queries are supported at this time");if(this.stmt.from.length!==1)throw Error("Multi-table queries are not supported");let r=this.stmt.from[0].relname;console.log("table:",r);let e=this.catalog.options.source;if(this.stmt.columns.length===1){if(this.stmt.columns[0].name==="*")return console.log("columns: *"),this.plan.args=t.csvInput().jsonOutput().cat().fileSource(e).getArgs(),this.plan;let s=this.stmt.columns[0].name.replace(/[^a-zA-Z0-9]/g,"_");if(!this.catalog.metadata.columns.includes(s))throw new Error(`column-not-found: ${s}`);return this.plan.args=t.csvInput().jsonOutput().implicitCsvHeader(this.catalog.getColumns()).fileSource(e).getArgs(),this.plan}if(this.stmt.columns.length>1){let s=this.stmt.columns.map(a=>{let m=a.name.replace(/[^a-zA-Z0-9]/g,"_");if(!this.catalog.metadata.columns.includes(m))throw new Error(`column ${a.name} is not in the list of columns`);return m}).join(",");return this.plan.args=["--icsv","--ojson","--implicit-csv-header","label",`${this.catalog.metadata.columns.join(",")}`,"then","cut","-o","-f",s,e],this.plan}throw Error("Error: no columns specified")}};function z(i,t){return new T(i,t).analyze()}var q=require("pgsql-parser"),I=class{constructor(t){this.query=t,this.stmt={type:"",distinct:!1,columns:[{name:"",type:""}],from:[{schemaname:"",relname:"",inh:""}],sort:{},where:{operator:"",left:"",right:""},group:[],having:[],orderBy:[],limit:{type:"",val:""}}}getStmt(){return this.stmt}getColumns(){return this.stmt.columns.map(t=>t.name)}isDistinct(){return this.stmt.distinct}getWhere(){return this.stmt.where}limit(){return parseInt(this.stmt.limit.val)}getTable(){return this.stmt.from[0].relname}getType(){return this.stmt.type}parse(){var a,m;let t=this.query;if(t.trim()==="")throw new Error("invalid-query: no query found");let r=(0,q.parse)(t);Object.keys(r[0].RawStmt.stmt)[0]==="SelectStmt"&&(this.stmt.type="select");let e=r[0].RawStmt.stmt.SelectStmt,s=e.limitOption;if(s==="LIMIT_OPTION_DEFAULT"&&(this.stmt.limit={type:e.limitOption,val:""}),s==="LIMIT_OPTION_COUNT"&&e.limitCount!==""&&(this.stmt.limit={type:e.limitOption,val:e.limitCount.A_Const.val.Integer.ival}),e.distinctClause!==void 0&&(this.stmt.distinct=!0),e.targetList!==void 0&&(this.stmt.columns=e.targetList.map(o=>{let n=o.ResTarget.val.ColumnRef.fields[0];return n.A_Star!==void 0?{name:"*"}:{name:n.String.str}})),e.fromClause!==void 0&&(this.stmt.from=e.fromClause.map(o=>{let n={schemaname:"",relname:"",inh:""},l=o.RangeVar;return l.schemaname!==void 0&&(n.schemaname=l.schemaname),l.relname!==void 0&&(n.relname=l.relname),l.inh!==void 0&&(n.inh=l.inh),n})),e.whereClause!==void 0){if(e.whereClause!==null&&((a=e==null?void 0:e.whereClause)==null?void 0:a.A_Expr.kind)==="AEXPR_OP"){let o=e.whereClause.A_Expr,n={operator:"",left:"",right:""};n.operator=o.name[0].String.str,o.lexpr!==void 0&&(n.left=o.lexpr.ColumnRef.fields[0].String.str),o.rexpr!==void 0&&(o.rexpr.ColumnRef!==void 0&&Object.keys(o.rexpr.ColumnRef.fields[0]).includes("String")&&(n.right=o.rexpr.ColumnRef.fields[0].String.str),o.rexpr.A_Const!==void 0&&(n.right=o.rexpr.A_Const.val.Integer.ival)),this.stmt.where=n}e.whereClause.A_Expr!==void 0&&((m=e==null?void 0:e.whereClause)==null||m.A_Expr.kind),e.whereClause.BoolExpr!==void 0&&(e.whereClause.BoolExpr.boolop,e.whereClause.BoolExpr.boolop)}return this.stmt}};function S(i){let t=new I(i);return t.parse(),t}var D=require("child_process"),N=require("fs");function X(i,t){return u(this,null,function*(){if(i===void 0||i==="")throw new Error("No query provided");let r=S(i);if(r.getType()!=="select")throw new Error("Only select queries are supported at this time");let e=yield E(t),s=z(e,r.getStmt()),a=(0,D.spawn)(s.cmd,s.args);if(a.on("error",o=>{console.error(o)}),a.stdout===null)throw new Error("stdout is null");let m=(0,N.createWriteStream)(e.getDestination());a.stdout.pipe(m)})}0&&(module.exports={createCatalog,parser,query});
