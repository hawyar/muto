var B=Object.create;var h=Object.defineProperty;var L=Object.getOwnPropertyDescriptor;var H=Object.getOwnPropertyNames;var U=Object.getPrototypeOf,W=Object.prototype.hasOwnProperty;var j=i=>h(i,"__esModule",{value:!0});var X=(i,t)=>{for(var n in t)h(i,n,{get:t[n],enumerable:!0})},O=(i,t,n,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of H(t))!W.call(i,s)&&(n||s!=="default")&&h(i,s,{get:()=>t[s],enumerable:!(e=L(t,s))||e.enumerable});return i},f=(i,t)=>O(j(h(i!=null?B(U(i)):{},"default",!t&&i&&i.__esModule?{get:()=>i.default,enumerable:!0}:{value:i,enumerable:!0})),i),Z=(i=>(t,n)=>i&&i.get(t)||(n=O(j({}),t,1),i&&i.set(t,n),n))(typeof WeakMap!="undefined"?new WeakMap:0);var c=(i,t,n)=>new Promise((e,s)=>{var a=r=>{try{o(n.next(r))}catch(l){s(l)}},m=r=>{try{o(n.throw(r))}catch(l){s(l)}},o=r=>r.done?e(r.value):Promise.resolve(r.value).then(a,m);o((n=n.apply(i,t)).next())});var G={};X(G,{Analyzer:()=>S,createCatalog:()=>g,fileExists:()=>T,millerCmd:()=>M,parseS3URI:()=>N,parseStmt:()=>w,query:()=>V});var u=f(require("path"),1),v=f(require("os"),1),P=f(require("fs"),1),$=require("child_process"),_=f(require("util"),1),x=_.default.promisify($.exec),R=(0,u.join)(process.cwd(),"node_modules",".bin","mlr@v6.0.0"),A=class{constructor(t){this.name=t.name!==""?t.name:u.default.basename(t.source),this.options=t,this.createdAt=new Date,this.metadata={fileName:u.default.basename(t.source),type:"csv",columns:[],header:!1,extension:"",size:0,rowCount:0,spanMultipleLines:!1,quotes:!1,delimiter:",",errors:{},warnings:{}}}getName(){return this.name}getOptions(){return this.options}getMetadata(){return this.metadata}getColumns(){return this.metadata.columns}rowCount(){return c(this,null,function*(){let t=yield x(`${R} --ojson count ${this.options.source}`);if(t.stderr!=="")throw new Error(`failed-to-get-row-count: ${t.stderr}`);let n=JSON.parse(t.stdout);if(n.length===0)throw new Error("failed-to-get-row-count: no rows found");if(n[0].count===void 0)throw new Error("failed-to-get-row-count: no count found");this.metadata.rowCount=n[0].count})}columnHeader(){return c(this,null,function*(){let t=yield x(`${R} --icsv --ojson head -n 1 ${this.options.source}`);if(t.stderr!=="")throw new Error(`failed-to-get-header-column: ${t.stderr}`);let n=JSON.parse(t.stdout);if(n.length===0)throw new Error("failed-to-get-header-column: no columns found");this.metadata.columns=this.sanitizeColumnNames(Object.keys(n[0]))})}sanitizeColumnNames(t){return t.map(n=>n.replace(/[^a-zA-Z0-9]/g,"_"))}fileExtension(){this.options.source.endsWith(".csv")&&(this.metadata.extension="csv"),this.options.source.endsWith(".json")&&(this.metadata.extension="json")}fileType(){return c(this,null,function*(){if(v.default.platform()!=="linux"&&v.default.platform()!=="darwin")throw new Error("unsupported-platform");let t=yield x(`file ${this.options.source} --mime-type`);if(t.stderr!=="")throw new Error(`failed-to-detect-mime-type: ${t.stderr}`);let n=t.stdout.split(":")[1].trim();if(n==="")throw new Error("failed-to-detect-mime-type");if(n==="text/csv"){this.metadata.type="csv";return}if(n==="application/json"){this.metadata.type="json";return}throw new Error("unsupported-file-type")})}fileSize(){return c(this,null,function*(){let t=yield P.default.promises.stat(this.options.source);this.metadata.size=t.size})}};function g(i,t){return c(this,null,function*(){return yield new Promise((n,e)=>{t===void 0&&e(new Error("missing-catalog-options")),(t.source===void 0||t.source==="")&&e(new Error("failed-to-create-catalog: no source provided")),(t.destination===void 0||t.destination==="")&&e(new Error("failed-to-create-catalog: no destination provided"));let s=Object.assign({},t);if((t.name===void 0||t.name==="")&&(s.name=u.default.basename(t.source).split(".")[0]),t.input===void 0)switch(u.default.extname(t.source)){case".csv":s.input="csv";break;case".json":s.input="json";break;default:e(new Error("failed-to-create-catalog: unsupported input file type"))}if(t.output===void 0)switch(u.default.extname(t.destination)){case".csv":s.output="csv";break;case".json":s.output="json";break;default:e(new Error("failed-to-create-catalog: unsupported output file type"))}let a=new A(s);Promise.all([a.fileSize(),a.fileType(),a.fileExtension(),a.rowCount(),a.columnHeader()]).then(()=>{console.log(`processing file: ${a.getMetadata().fileName}`),n(a)}).catch(m=>e(m))})})}var C=require("child_process");var k=require("pgsql-parser"),I=class{constructor(){this.query="",this.stmt={type:"",distinct:!1,columns:[{name:"",type:""}],from:[{schemaname:"",relname:"",inh:""}],sort:{},where:{},group:[],having:[],orderBy:[],limit:{type:"",val:""}}}parse(t){var a,m;if(t.trim()==="")throw new Error("invalid-query: no query found");let n=(0,k.parse)(t);Object.keys(n[0].RawStmt.stmt)[0]==="SelectStmt"&&(this.stmt.type="select");let e=n[0].RawStmt.stmt.SelectStmt,s=e.limitOption;if(s==="LIMIT_OPTION_DEFAULT"&&(this.stmt.limit={type:e.limitOption,val:""}),s==="LIMIT_OPTION_COUNT"&&e.limitCount!==""&&(this.stmt.limit={type:e.limitOption,val:e.limitCount.A_Const.val.Integer.ival}),e.distinctClause!==void 0&&(this.stmt.distinct=!0),e.targetList!==void 0&&(this.stmt.columns=e.targetList.map(o=>{let r=o.ResTarget.val.ColumnRef.fields[0];return r.A_Star!==void 0?{name:"*"}:{name:r.String.str}})),e.fromClause!==void 0&&(this.stmt.from=e.fromClause.map(o=>{let r={schemaname:"",relname:"",inh:""},l=o.RangeVar;return l.schemaname!==void 0&&(r.schemaname=l.schemaname),l.relname!==void 0&&(r.relname=l.relname),l.inh!==void 0&&(r.inh=l.inh),r})),e.whereClause!==void 0){if(e.whereClause!==null&&((a=e==null?void 0:e.whereClause)==null?void 0:a.A_Expr.kind)==="AEXPR_OP"){let o=e.whereClause.A_Expr,r={operator:"",left:{},right:{}};r.operator=o.name[0].String.str,o.lexpr!==void 0&&(r.left=o.lexpr.ColumnRef.fields[0].String.str),o.rexpr!==void 0&&(o.rexpr.ColumnRef!==void 0&&Object.keys(o.rexpr.ColumnRef.fields[0]).includes("String")&&(r.right=o.rexpr.ColumnRef.fields[0].String.str),o.rexpr.A_Const!==void 0&&(r.right=o.rexpr.A_Const.val.Integer.ival)),this.stmt.where=r}e.whereClause.A_Expr!==void 0&&((m=e==null?void 0:e.whereClause)==null?void 0:m.A_Expr.kind)==="AEXPR_IN",e.whereClause.BoolExpr!==void 0&&(e.whereClause.BoolExpr.boolop==="AND_EXPR",e.whereClause.BoolExpr.boolop==="OR_EXPR")}return this.stmt}};function w(i){return new I().parse(i)}var p=require("fs"),b=f(require("is-installed-globally"),1),E=require("path"),q=require("process");var z=require("@aws-sdk/credential-providers"),y=require("@aws-sdk/client-s3"),F=i=>(0,z.fromIni)({profile:i,mfaCodeProvider:t=>c(void 0,null,function*(){return t})});function J(i){return new y.S3Client(i)}function T(i,t){return c(this,null,function*(){let n=J({credentials:F("default"),region:"us-east-2"}),e=new y.HeadObjectCommand({Bucket:i,Key:t}),s=yield n.send(e);return console.log(s.$metadata),!(s.$metadata.httpStatusCode!==void 0&&s.$metadata.httpStatusCode!==200)})}function N(i,t){t===void 0&&(t={file:!1});let n={file:t.file?t.file:!1};if(!i.startsWith("s3://")||i.split(":/")[0]!=="s3")throw new Error(`invalid-s3-uri: ${i}`);let e="",s={bucket:"",key:"",file:""},a=i.split(":/")[1],[m,...o]=a.split("/").splice(1);return s.bucket=m,s.key=o.join("/"),o.forEach((r,l)=>{if(l===o.length-1){let d=r.split(".").length;if(n.file&&d===1&&(e=`uri should be a given, given: ${i}`),!n.file&&d===1)return;if(!n.file&&d>1){console.log(r),e=`Invalid S3 uri, ${i} should not end with a file name`;return}!n.file&&r.split(".")[1]!==""&&d>1&&(e=`${i} should not be a file endpoint: ${r}`),d>1&&r.split(".")[1]!==""&&(s.file=r)}}),{data:s,err:e}}function V(i,t){return c(this,null,function*(){let n=yield g(i,t);if(n==null)throw new Error("failed-to-create-catalog");let e=new S(n,w(i)).analyze();console.log(e.cmd+" "+e.args.join(" "));let{stdout:s}=(0,C.exec)(e.cmd+" "+e.args.join(" "),{maxBuffer:1024*1024*1024});if(s===null)throw new Error("failed-to-execute-query");s.on("close",()=>{console.log("done executing query")}),s.pipe((0,p.createWriteStream)(n.options.destination))})}var S=class{constructor(t,n){this.stmt=n,this.catalog=t,this.plan={cmd:"",args:[]}}analyze(){console.log("analyzing query:");let t=M();if(this.plan.cmd=t.getPath(),this.stmt.type!=="select")throw new Error("not-implemented: only select queries are supported at this time");if(this.stmt.from.length===1){let n=this.stmt.from[0].relname;console.log("	 table:",n);let e=this.catalog.options.source;if(this.stmt.columns.length===1){if(this.stmt.columns[0].name==="*")return this.plan.args=["--icsv","--ojson","--implicit-csv-header","label",`${this.catalog.metadata.columns.join(",")}`,e],this.plan;let s=this.stmt.columns[0].name.replace(/[^a-zA-Z0-9]/g,"_");if(!this.catalog.metadata.columns.includes(s))throw new Error(`column-not-found: ${s}`);return console.log("	 column:",s),this.plan.args=["--icsv","--ojson","--implicit-csv-header","label",`${this.catalog.metadata.columns.join(",")}`,"then","cut","-f",s,e],this.plan}if(this.stmt.columns.length>1){let s=this.stmt.columns.map(a=>{let m=a.name.replace(/[^a-zA-Z0-9]/g,"_");if(!this.catalog.metadata.columns.includes(m))throw new Error(`column ${a.name} is not in the list of columns`);return m}).join(",");return console.log("	 columns: ",s),this.plan.args=["--icsv","--ojson","--implicit-csv-header","label",`${this.catalog.metadata.columns.join(",")}`,"then","cut","-o","-f",s,e],this.plan}}return this.plan}},D=class{constructor(){this.path="",this.version="6.0.0",this.cmd="mlr@v"+this.version,this.args=[]}getPath(){if(this.path==="")throw new Error("miller-path-not-set: missing miller binary path");return this.path}getCmd(){return this.cmd}csvInput(){this.args.push("--icsv")}jsonInput(){this.args.push("--ijson")}csvOutput(){this.args.push("--ocsv")}jsonOutput(){this.args.push("--ojson")}implicitCsvHeader(t){this.args.push(`--implicit-csv-header label ${t.join(",")}`)}findBinPath(){if(console.log(b.default),!b.default){let e=(0,E.join)((0,q.cwd)(),"/node_modules",".bin",this.cmd);if(console.log("checking for local binary:",e),(0,p.existsSync)(e)){this.path=e;return}}let t=(0,C.execSync)("npm root -g");if(t===null)throw new Error('failed-command: "npm root -g"');let n=(0,E.join)(t.toString().trim(),"muto","node_modules",".bin",this.cmd);if(console.log("global:",n),(0,p.existsSync)(n)){this.path=n;return}throw new Error("unable-to-find-mlr: make sure the `npm run prepare` command has been run")}};function M(){let i=new D;return i.findBinPath(),i}module.exports=Z(G);0&&(module.exports={Analyzer,createCatalog,fileExists,millerCmd,parseS3URI,parseStmt,query});
