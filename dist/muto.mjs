var a=(i,t,o)=>new Promise((e,r)=>{var l=n=>{try{m(o.next(n))}catch(s){r(s)}},c=n=>{try{m(o.throw(n))}catch(s){r(s)}},m=n=>n.done?e(n.value):Promise.resolve(n.value).then(l,c);m((o=o.apply(i,t)).next())});import O,{join as $}from"path";import g from"os";import d from"fs";import{exec as P}from"child_process";import{fromIni as E}from"@aws-sdk/credential-providers";import{S3Client as b}from"@aws-sdk/client-s3";var f=i=>E({profile:i,mfaCodeProvider:t=>a(void 0,null,function*(){return t})});function p(i){return new b(i)}import R from"util";var h=R.promisify(P),w=$(process.cwd(),"node_modules",".bin","mlr@v6.0.0"),y=class{constructor(t){this.name=t.name!==""?t.name:O.basename(t.source),this.options=t,this.env="local",this.createdAt=new Date,this.state="init",this.connector=null,this.loader=null,this.metadata={type:"",columns:[],header:!1,extension:"",size:0,rowCount:0,spanMultipleLines:!1,quotes:!1,delimiter:",",errors:{},warnings:{}}}rowCount(){return a(this,null,function*(){let t=yield h(`${w} --ojson count ${this.options.source}`);if(t.stderr!=="")throw new Error(`failed-to-get-row-count: ${t.stderr}`);let o=JSON.parse(t.stdout);if(o.length===0)throw new Error("failed-to-get-row-count: no rows found");if(o[0].count===void 0)throw new Error("failed-to-get-row-count: no count found");this.metadata.rowCount=o[0].count})}headerColumn(){return a(this,null,function*(){let t=yield h(`${w} --icsv --ojson head -n 1 ${this.options.source}`);if(t.stderr!=="")throw new Error(`failed-to-get-header-column: ${t.stderr}`);console.log(t);let o=JSON.parse(t.stdout);if(o.length===0)throw new Error("failed-to-get-header-column: no columns found");this.metadata.columns=Object.keys(o[0])})}fileType(){return a(this,null,function*(){if(g.platform()!=="linux"&&g.platform()!=="darwin")throw new Error("unsupported-platform");let t=yield h(`file ${this.options.source} --mime-type`);if(t.stderr!=="")throw new Error(`failed-to-detect-mime-type: ${t.stderr}`);let o=t.stdout.split(":")[1].trim();if(o==="")throw new Error("failed-to-detect-mime-type");this.options.source.endsWith(".csv")&&(this.metadata.extension="csv"),this.options.source.endsWith(".json")&&(this.metadata.extension="json"),this.metadata.type=o})}fileSize(){return a(this,null,function*(){let t=yield d.promises.stat(this.options.source);this.metadata.size=t.size})}determineLoader(){if(this.options.destination.startsWith("s3://")){this.loader=p({credentials:f("default"),region:"us-east-2"});return}if(this.options.source.startsWith("/")||this.options.source.startsWith("../")||this.options.source.startsWith("./")){this.loader=d.createWriteStream(this.options.destination);return}throw new Error("unsupported-loader")}determineConnector(){if(this.options.source.startsWith("/")||this.options.source.startsWith("../")||this.options.source.startsWith("./")){if(!d.existsSync(this.options.source))throw new Error(`file: ${this.options.source} not found, please provide a valid file path`);this.connector=d.createReadStream(this.options.source);return}if(this.options.source.startsWith("s3://")){this.connector=p({credentials:f("default"),region:"us-east-2"});return}throw new Error(`unsupported-source for: ${this.options.source}`)}};function C(i,t){return a(this,null,function*(){return yield new Promise((o,e)=>{(t.source===""||t.source===void 0)&&e(new Error("failed-to-create-catalog: no source provided")),(t.destination===""||t.destination===void 0)&&e(new Error("failed-to-create-catalog: no destination provided")),(t.name===""||t.name===void 0)&&e(new Error("failed-to-create-catalog: no name provided")),t.input==="csv"&&!t.source.endsWith(".csv")&&e(new Error("failed-to-create-catalog: file extension does not match input type")),t.input==="json"&&!t.source.endsWith(".json")&&e(new Error("failed-to-create-catalog: file extension does not match input type"));let r=new y(t);Promise.all([r.determineConnector(),r.determineLoader(),r.headerColumn(),r.fileSize(),r.fileType(),r.rowCount()]).then(()=>{console.log(`created catalog for: ${t.name}`),o(r)}).catch(l=>e(l))})})}import{exec as _}from"child_process";import{parse as T}from"pgsql-parser";var v=class{constructor(){this.query="",this.stmt={type:"",distinct:!1,columns:[{name:"",type:""}],from:[{schemaname:"",relname:"",inh:""}],sort:{},where:{},group:[],having:[],orderBy:[],limit:{type:"",val:""}}}parse(t){var l,c,m;if(t.trim()==="")throw new Error("invalid-query: no query found");console.log(`raw: ${t}`);let o=T(t);Object.keys(o[0].RawStmt.stmt)[0]==="SelectStmt"&&(this.stmt.type="select");let e=o[0].RawStmt.stmt.SelectStmt,r=e.limitOption;if(r==="LIMIT_OPTION_DEFAULT"&&(this.stmt.limit={type:e.limitOption,val:""}),r==="LIMIT_OPTION_COUNT"&&e.limitCount!==""&&(this.stmt.limit={type:e.limitOption,val:e.limitCount.A_Const.val.Integer.ival}),e.distinctClause!==void 0&&(this.stmt.distinct=!0),e.targetList!==void 0&&(this.stmt.columns=e.targetList.map(n=>{let s=n.ResTarget.val.ColumnRef.fields[0];return s.A_Star!==void 0?{name:"*"}:{name:s.String.str}})),this.stmt.from=e.fromClause.map(n=>{let s={schemaname:"",relname:"",inh:""},u=n.RangeVar;return u.schemaname!==void 0&&(s.schemaname=u.schemaname),u.relname!==void 0&&(s.relname=u.relname),u.inh!==void 0&&(s.inh=u.inh),s}),e.whereClause!==void 0){if(e.whereClause!==null&&((l=e==null?void 0:e.whereClause)==null?void 0:l.A_Expr.kind)==="AEXPR_OP"){let n=e.whereClause.A_Expr,s={operator:"",left:{},right:{}};s.operator=n.name[0].String.str,n.lexpr!==null&&(s.left=n.lexpr.ColumnRef.fields[0].String.str),n.rexpr!==null&&(s.right=n.rexpr.ColumnRef.fields[0].String.str),this.stmt.where=s}if(((c=e==null?void 0:e.whereClause)==null?void 0:c.A_Expr)!==null&&((m=e==null?void 0:e.whereClause)==null?void 0:m.A_Expr.kind)==="AEXPR_IN"){let n=e.whereClause.A_Expr;console.log(n)}if(e.whereClause.BoolExpr!==null){if(e.whereClause.BoolExpr.boolop==="AND_EXPR"){let n=e.whereClause.BoolExpr.args;console.log(JSON.stringify(n,null,2))}if(e.whereClause.BoolExpr.boolop==="OR_EXPR"){let n=e.whereClause.BoolExpr.args;console.log(JSON.stringify(n,null,2))}}}return this.stmt}};function S(i){return new v().parse(i)}import{join as W}from"path";var A=W(process.cwd(),"node_modules",".bin","mlr@v6.0.0");function tt(i,t){return a(this,null,function*(){let o=S(i),e=yield C(i,t);if(e==null)throw new Error("failed-to-create-catalog");console.log(`created catalog for: ${e.name}`);let r=new x(e,o).analyze();console.log(`plan: ${JSON.stringify(r,null,2)}`);let{stdout:l,stderr:c}=_(r.cmd+" "+r.args.join(" "));console.log(`stdout: ${l}`),console.log(`stderr: ${c}`)})}var x=class{constructor(t,o){this.stmt=o,this.catalog=t,this.plan={cmd:"",args:[]}}analyze(){if(console.log("analyzing query"),this.plan.cmd=A,this.stmt.type!=="select")throw new Error("not-implemented: only select queries are supported at this time");if(console.log(this.stmt),this.stmt.from.length===1){let t=this.stmt.from[0].relname;console.log("from table: ",t);let o=this.catalog.options.source;if(this.stmt.columns.length===1){if(this.stmt.columns[0].name==="*")return this.plan.args=["--icsv","--ojson","cat",o],this.plan;this.plan.args=["--icsv","--ojson","cut","-f",this.stmt.columns[0].name,o]}if(this.stmt.columns.length>1){let e=this.stmt.columns.map(r=>r.name).join(",");return console.log("fields: ",e),this.plan.args=["--icsv","--ojson","cut","-o","-f",e,o],this.plan}}return this.plan}};export{tt as query};
