var c=(s,t,n)=>new Promise((e,i)=>{var a=r=>{try{o(n.next(r))}catch(l){i(l)}},m=r=>{try{o(n.throw(r))}catch(l){i(l)}},o=r=>r.done?e(r.value):Promise.resolve(r.value).then(a,m);o((n=n.apply(s,t)).next())});import d,{join as j}from"path";import g from"os";import O from"fs";import{exec as P}from"child_process";import $ from"util";var f=$.promisify(P),w=j(process.cwd(),"node_modules",".bin","mlr@v6.0.0"),y=class{constructor(t){this.name=t.name!==""?t.name:d.basename(t.source),this.options=t,this.createdAt=new Date,this.metadata={fileName:d.basename(t.source),type:"csv",columns:[],header:!1,extension:"",size:0,rowCount:0,spanMultipleLines:!1,quotes:!1,delimiter:",",errors:{},warnings:{}}}getName(){return this.name}getOptions(){return this.options}getMetadata(){return this.metadata}getColumns(){return this.metadata.columns}rowCount(){return c(this,null,function*(){let t=yield f(`${w} --ojson count ${this.options.source}`);if(t.stderr!=="")throw new Error(`failed-to-get-row-count: ${t.stderr}`);let n=JSON.parse(t.stdout);if(n.length===0)throw new Error("failed-to-get-row-count: no rows found");if(n[0].count===void 0)throw new Error("failed-to-get-row-count: no count found");this.metadata.rowCount=n[0].count})}columnHeader(){return c(this,null,function*(){let t=yield f(`${w} --icsv --ojson head -n 1 ${this.options.source}`);if(t.stderr!=="")throw new Error(`failed-to-get-header-column: ${t.stderr}`);let n=JSON.parse(t.stdout);if(n.length===0)throw new Error("failed-to-get-header-column: no columns found");this.metadata.columns=this.sanitizeColumnNames(Object.keys(n[0]))})}sanitizeColumnNames(t){return t.map(n=>n.replace(/[^a-zA-Z0-9]/g,"_"))}fileExtension(){this.options.source.endsWith(".csv")&&(this.metadata.extension="csv"),this.options.source.endsWith(".json")&&(this.metadata.extension="json")}fileType(){return c(this,null,function*(){if(g.platform()!=="linux"&&g.platform()!=="darwin")throw new Error("unsupported-platform");let t=yield f(`file ${this.options.source} --mime-type`);if(t.stderr!=="")throw new Error(`failed-to-detect-mime-type: ${t.stderr}`);let n=t.stdout.split(":")[1].trim();if(n==="")throw new Error("failed-to-detect-mime-type");if(n==="text/csv"){this.metadata.type="csv";return}if(n==="application/json"){this.metadata.type="json";return}throw new Error("unsupported-file-type")})}fileSize(){return c(this,null,function*(){let t=yield O.promises.stat(this.options.source);this.metadata.size=t.size})}};function p(s,t){return c(this,null,function*(){return yield new Promise((n,e)=>{t===void 0&&e(new Error("missing-catalog-options")),(t.source===void 0||t.source==="")&&e(new Error("failed-to-create-catalog: no source provided")),(t.destination===void 0||t.destination==="")&&e(new Error("failed-to-create-catalog: no destination provided"));let i=Object.assign({},t);if((t.name===void 0||t.name==="")&&(i.name=d.basename(t.source).split(".")[0]),t.input===void 0)switch(d.extname(t.source)){case".csv":i.input="csv";break;case".json":i.input="json";break;default:e(new Error("failed-to-create-catalog: unsupported input file type"))}if(t.output===void 0)switch(d.extname(t.destination)){case".csv":i.output="csv";break;case".json":i.output="json";break;default:e(new Error("failed-to-create-catalog: unsupported output file type"))}let a=new y(i);Promise.all([a.fileSize(),a.fileType(),a.fileExtension(),a.rowCount(),a.columnHeader()]).then(()=>{console.log(`processing file: ${a.getMetadata().fileName}`),n(a)}).catch(m=>e(m))})})}import{exec as q,execSync as D}from"child_process";import{parse as _}from"pgsql-parser";var C=class{constructor(){this.query="",this.stmt={type:"",distinct:!1,columns:[{name:"",type:""}],from:[{schemaname:"",relname:"",inh:""}],sort:{},where:{},group:[],having:[],orderBy:[],limit:{type:"",val:""}}}parse(t){var a,m;if(t.trim()==="")throw new Error("invalid-query: no query found");let n=_(t);Object.keys(n[0].RawStmt.stmt)[0]==="SelectStmt"&&(this.stmt.type="select");let e=n[0].RawStmt.stmt.SelectStmt,i=e.limitOption;if(i==="LIMIT_OPTION_DEFAULT"&&(this.stmt.limit={type:e.limitOption,val:""}),i==="LIMIT_OPTION_COUNT"&&e.limitCount!==""&&(this.stmt.limit={type:e.limitOption,val:e.limitCount.A_Const.val.Integer.ival}),e.distinctClause!==void 0&&(this.stmt.distinct=!0),e.targetList!==void 0&&(this.stmt.columns=e.targetList.map(o=>{let r=o.ResTarget.val.ColumnRef.fields[0];return r.A_Star!==void 0?{name:"*"}:{name:r.String.str}})),e.fromClause!==void 0&&(this.stmt.from=e.fromClause.map(o=>{let r={schemaname:"",relname:"",inh:""},l=o.RangeVar;return l.schemaname!==void 0&&(r.schemaname=l.schemaname),l.relname!==void 0&&(r.relname=l.relname),l.inh!==void 0&&(r.inh=l.inh),r})),e.whereClause!==void 0){if(e.whereClause!==null&&((a=e==null?void 0:e.whereClause)==null?void 0:a.A_Expr.kind)==="AEXPR_OP"){let o=e.whereClause.A_Expr,r={operator:"",left:{},right:{}};r.operator=o.name[0].String.str,o.lexpr!==void 0&&(r.left=o.lexpr.ColumnRef.fields[0].String.str),o.rexpr!==void 0&&(o.rexpr.ColumnRef!==void 0&&Object.keys(o.rexpr.ColumnRef.fields[0]).includes("String")&&(r.right=o.rexpr.ColumnRef.fields[0].String.str),o.rexpr.A_Const!==void 0&&(r.right=o.rexpr.A_Const.val.Integer.ival)),this.stmt.where=r}e.whereClause.A_Expr!==void 0&&((m=e==null?void 0:e.whereClause)==null?void 0:m.A_Expr.kind)==="AEXPR_IN",e.whereClause.BoolExpr!==void 0&&(e.whereClause.BoolExpr.boolop==="AND_EXPR",e.whereClause.BoolExpr.boolop==="OR_EXPR")}return this.stmt}};function h(s){return new C().parse(s)}import{createWriteStream as M,existsSync as v}from"fs";import x from"is-installed-globally";import{join as b}from"path";import{cwd as B}from"process";import{fromIni as R}from"@aws-sdk/credential-providers";import{S3Client as A,HeadObjectCommand as k}from"@aws-sdk/client-s3";var I=s=>R({profile:s,mfaCodeProvider:t=>c(void 0,null,function*(){return t})});function z(s){return new A(s)}function T(s,t){return c(this,null,function*(){let n=z({credentials:I("default"),region:"us-east-2"}),e=new k({Bucket:s,Key:t}),i=yield n.send(e);return console.log(i.$metadata),!(i.$metadata.httpStatusCode!==void 0&&i.$metadata.httpStatusCode!==200)})}function N(s,t){t===void 0&&(t={file:!1});let n={file:t.file?t.file:!1};if(!s.startsWith("s3://")||s.split(":/")[0]!=="s3")throw new Error(`invalid-s3-uri: ${s}`);let e="",i={bucket:"",key:"",file:""},a=s.split(":/")[1],[m,...o]=a.split("/").splice(1);return i.bucket=m,i.key=o.join("/"),o.forEach((r,l)=>{if(l===o.length-1){let u=r.split(".").length;if(n.file&&u===1&&(e=`uri should be a given, given: ${s}`),!n.file&&u===1)return;if(!n.file&&u>1){console.log(r),e=`Invalid S3 uri, ${s} should not end with a file name`;return}!n.file&&r.split(".")[1]!==""&&u>1&&(e=`${s} should not be a file endpoint: ${r}`),u>1&&r.split(".")[1]!==""&&(i.file=r)}}),{data:i,err:e}}function ut(s,t){return c(this,null,function*(){let n=yield p(s,t);if(n==null)throw new Error("failed-to-create-catalog");let e=new E(n,h(s)).analyze();console.log(e.cmd+" "+e.args.join(" "));let{stdout:i}=q(e.cmd+" "+e.args.join(" "),{maxBuffer:1024*1024*1024});if(i===null)throw new Error("failed-to-execute-query");i.on("close",()=>{console.log("done executing query")}),i.pipe(M(n.options.destination))})}var E=class{constructor(t,n){this.stmt=n,this.catalog=t,this.plan={cmd:"",args:[]}}analyze(){console.log("analyzing query:");let t=L();if(this.plan.cmd=t.getPath(),this.stmt.type!=="select")throw new Error("not-implemented: only select queries are supported at this time");if(this.stmt.from.length===1){let n=this.stmt.from[0].relname;console.log("	 table:",n);let e=this.catalog.options.source;if(this.stmt.columns.length===1){if(this.stmt.columns[0].name==="*")return this.plan.args=["--icsv","--ojson","--implicit-csv-header","label",`${this.catalog.metadata.columns.join(",")}`,e],this.plan;let i=this.stmt.columns[0].name.replace(/[^a-zA-Z0-9]/g,"_");if(!this.catalog.metadata.columns.includes(i))throw new Error(`column-not-found: ${i}`);return console.log("	 column:",i),this.plan.args=["--icsv","--ojson","--implicit-csv-header","label",`${this.catalog.metadata.columns.join(",")}`,"then","cut","-f",i,e],this.plan}if(this.stmt.columns.length>1){let i=this.stmt.columns.map(a=>{let m=a.name.replace(/[^a-zA-Z0-9]/g,"_");if(!this.catalog.metadata.columns.includes(m))throw new Error(`column ${a.name} is not in the list of columns`);return m}).join(",");return console.log("	 columns: ",i),this.plan.args=["--icsv","--ojson","--implicit-csv-header","label",`${this.catalog.metadata.columns.join(",")}`,"then","cut","-o","-f",i,e],this.plan}}return this.plan}},S=class{constructor(){this.path="",this.version="6.0.0",this.cmd="mlr@v"+this.version,this.args=[]}getPath(){if(this.path==="")throw new Error("miller-path-not-set: missing miller binary path");return this.path}getCmd(){return this.cmd}csvInput(){this.args.push("--icsv")}jsonInput(){this.args.push("--ijson")}csvOutput(){this.args.push("--ocsv")}jsonOutput(){this.args.push("--ojson")}implicitCsvHeader(t){this.args.push(`--implicit-csv-header label ${t.join(",")}`)}findBinPath(){if(console.log(x),!x){let e=b(B(),"/node_modules",".bin",this.cmd);if(console.log("checking for local binary:",e),v(e)){this.path=e;return}}let t=D("npm root -g");if(t===null)throw new Error('failed-command: "npm root -g"');let n=b(t.toString().trim(),"muto","node_modules",".bin",this.cmd);if(console.log("global:",n),v(n)){this.path=n;return}throw new Error("unable-to-find-mlr: make sure the `npm run prepare` command has been run")}};function L(){let s=new S;return s.findBinPath(),s}export{E as Analyzer,p as createCatalog,T as fileExists,L as millerCmd,N as parseS3URI,h as parseStmt,ut as query};
