var N=Object.create;var y=Object.defineProperty;var W=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames;var z=Object.getPrototypeOf,I=Object.prototype.hasOwnProperty;var P=s=>y(s,"__esModule",{value:!0});var _=(s,t)=>{for(var e in t)y(s,e,{get:t[e],enumerable:!0})},x=(s,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of A(t))!I.call(s,n)&&(e||n!=="default")&&y(s,n,{get:()=>t[n],enumerable:!(r=W(t,n))||r.enumerable});return s},v=(s,t)=>x(P(y(s!=null?N(z(s)):{},"default",!t&&s&&s.__esModule?{get:()=>s.default,enumerable:!0}:{value:s,enumerable:!0})),s),q=(s=>(t,e)=>s&&s.get(t)||(e=x(P({}),t,1),s&&s.set(t,e),e))(typeof WeakMap!="undefined"?new WeakMap:0);var u=(s,t,e)=>new Promise((r,n)=>{var i=o=>{try{c(e.next(o))}catch(l){n(l)}},a=o=>{try{c(e.throw(o))}catch(l){n(l)}},c=o=>o.done?r(o.value):Promise.resolve(o.value).then(i,a);c((e=e.apply(s,t)).next())});var V={};_(V,{createCatalog:()=>L,createWorkflow:()=>J});var h=v(require("fs"),1),C=require("child_process"),$=v(require("os"),1),w=v(require("path"),1),b=require("vfile"),R=require("pgsql-parser"),O=require("readline"),p=require("@aws-sdk/client-s3"),k=require("@aws-sdk/credential-providers");const g=(0,w.join)(process.cwd(),"node_modules",".bin","mlr@v6.0.0");var M=(a=>(a.COMMA=",",a.TAB="	",a.SPACE=" ",a.PIPE="|",a.SEMICOLON=";",a.COLON=":",a))(M||{});const S=s=>(0,k.fromIni)({profile:s,mfaCodeProvider:t=>u(void 0,null,function*(){return t})});function E(s){return new p.S3Client(s)}function T(s,t){const e={file:t.file?t.file:!1};if(!s.startsWith("s3://")||s.split(":/")[0]!=="s3")throw new Error(`invalid-s3-uri: ${s}`);let r="";const n={bucket:"",key:"",file:""},i=s.split(":/")[1],[a,...c]=i.split("/").splice(1);return n.bucket=a,n.key=c.join("/"),c.forEach((o,l)=>{if(l===c.length-1){const d=o.split(".").length;if(e.file&&d===1&&(r=`uri should be a given, given: ${s}`),!e.file&&d===1)return;if(!e.file&&d>1){r=`Invalid S3 uri, ${s} should not end with a file name`;return}!e.file&&o.split(".")[1]!==""&&d>1&&(r=`${s} should not be a file endpoint: ${o}`),d>1&&o.split(".")[1]!==""&&(n.file=o)}}),{data:n,err:r}}class B{constructor(t){this.name=t.name!==""?t.name:w.default.basename(t.source),this.options=t,this.env="local",this.init=new Date,this.state="init",this.pcount=0,this.columns=[],this.connector=null,this.loader=null,this.vfile=new b.VFile({path:this.options.source}),this.stmt={type:"",distinct:!1,columns:[{name:"",type:""}],from:[{schemaname:"",relname:"",inh:""}],sort:[],where:{},group:[],orderBy:[],having:[],limit:{type:"",val:""}}}toJson(){return u(this,null,function*(){return this.exec(g,["--icsv","--ojson","clean-whitespace",this.options.source,">",this.options.destination])})}rowCount(){return u(this,null,function*(){const t=yield this.exec(g,["--ojson","count",this.options.source]),e=yield this.promisifyProcessResult(t);if(e.code!==0)throw new Error(`Error while counting rows: ${e.stderr}`);if(e.stderr!=="")throw new Error(e.stderr);const r=JSON.parse(e.stdout);if(r.length===0)throw new Error("Error while counting rows");if(r[0].count===void 0)throw new Error("Error while counting rows");return r[0].count})}headerColumn(){return u(this,null,function*(){const t=yield this.exec(g,["--icsv","--ojson","head","-n","1",this.options.source]),e=yield this.promisifyProcessResult(t);if(e.code!==0)throw new Error(`Error while getting column header: ${e.stderr}`);const r=JSON.parse(e.stdout);if(r.length===0)throw new Error("No columns found");this.columns=Object.keys(r[0])})}preview(t=20,e){return u(this,null,function*(){if(e===void 0)throw new Error("stream-destination-undefined");if(e!==null&&e!==this.options.source&&h.default.createWriteStream(e)instanceof h.default.WriteStream){const i=h.default.createWriteStream(e);return(yield this.exec(g,["--icsv","--ojson","head","-n",t.toString(),this.options.source])).stdout.pipe(i),console.warn(`preview saved to: ${e}`),e}const r=yield this.exec(g,["--icsv","--ojson","head","-n",t.toString(),this.options.source]),n=yield this.promisifyProcessResult(r);if(n.stderr!=="")throw new Error(n.stderr);if(n.code!==0)throw new Error("Error while executing mlr command");return this.vfile.data.preview=JSON.parse(n.stdout),JSON.parse(n.stdout)})}determineShape(){return u(this,null,function*(){const t=this.options.source,e={type:"",size:0,columns:[],header:!1,encoding:"utf-8",bom:!1,spanMultipleLines:!1,quotes:!1,delimiter:",",errors:{},warnings:{},preview:[]};if(e.size=yield this.fileSize(),$.default.platform()==="win32")throw new Error("scream");const r=this.exec("file",[t,"--mime-type"]),n=yield this.promisifyProcessResult(r);if(n.stderr!=="")throw new Error(`failed-to-detect-mime-type: ${n.stderr}`);if(n.code!==0)throw new Error(`failed-to-detect-mime-type: ${n.stderr}`);e.type=n.stdout.split(":")[1].trim();const i=(0,O.createInterface)({input:h.default.createReadStream(t),crlfDelay:1/0});let a=0;const c=20,o={row:[""],del:""};let l="";const d=[",",";","	","|",":"," ","|"];i.on("line",f=>{if(a===0&&(d.forEach(m=>{f.split(m).length>1&&(o.row=f.split(m),o.del=m)}),(o.del===""||o.row.length<=1)&&(e.errors.unrecognizedDelimiter=`${t} does not have a recognized delimiter`,e.header=!1),o.row.forEach(m=>{isNaN(parseInt(m.substring(0,3)))||(e.header=!1,e.warnings.noHeader="no header found",a++)}),e.header=!0,e.delimiter=o.del,e.columns=o.row),a>0&&a<c){const m=f.split('"').length-1;if(l!==""&&m%2!==0&&(e.spanMultipleLines=!0),m%2!==0&&f.split('""').length-1!==1&&(l=f),f.split(o.del).length!==o.row.length){e.errors.rowWidthMismatch="row width mismatch";return}e.preview.push(f.split(o.del))}a++}),i.on("close",()=>{this.vfile.data.shape=e})})}determineLoader(){if(this.options.destination.startsWith("s3://")){this.loader=E({credentials:S("default"),region:"us-east-2"});return}if(this.options.source.startsWith("/")||this.options.source.startsWith("../")||this.options.source.startsWith("./")){this.loader=h.default.createReadStream(this.options.source);return}throw new Error("unsupported-loader")}determineConnector(){switch(this.env){case"local":if(!h.default.existsSync(this.options.source))throw new Error(`file: ${this.options.source} not found, please provide a valid file path`);this.connector=h.default.createReadStream(this.options.source);break;case"aws":this.connector=E({credentials:S("default"),region:"us-east-2"});break;default:throw new Error(`unsupported-source for: ${this.options.source}`)}}determineEnv(){const t=this.options.source;if(t.startsWith("/")||t.startsWith("../")||t.startsWith("./")){this.env="local";return}if(t.startsWith("s3://")){this.env="aws";return}throw new Error(`invalid-source-type: ${t}`)}fileSize(){return u(this,null,function*(){const t=this.options.source,e=50*1024*1024,r=yield h.default.promises.stat(t);if(r.size>e)throw new Error(`file-size-exceeds-limit: ${t} is too large, please limit to under 50MB for now`);return this.vfile.data.size=r.size,r.size})}uploadToS3(){return u(this,null,function*(){const t=this.options.source,e=this.options.destination;if(t==="")throw new Error("source not definded");if(e==="")throw new Error("destination not definded");const r=h.default.createReadStream(t);if(!r.readable)throw new Error("failed-to-read-source: Make sure the provided file is readable");const n=yield this.fileSize();n>100*1024*1024&&console.warn(`file size ${n} is larger`);const{data:i,err:a}=T(e,{file:!0});if(a.toString().startsWith("invalid-s3-uri"))throw new Error(`failed-to-parse-s3-uri: ${a}`);i.file===""&&(i.file=w.default.basename(t),console.warn("Destination filename not provided. Using source source basename"+i.file)),console.log(`uploading ${t} to ${e}`);const o=yield E({region:"us-east-2"}).send(new p.PutObjectCommand({Bucket:i.bucket,Key:i.key+i.file,Body:r})).catch(l=>{throw new Error(`failed-upload-s3: Error while uploading to S3: ${l}`)}).finally(()=>{r.close()});if(o.$metadata.httpStatusCode!==void 0&&o.$metadata.httpStatusCode!==200)throw new Error(`failed-upload-s3: Error while uploading to S3: ${o.$metadata.httpStatusCode}`);if(o.$metadata.requestId===void 0)throw new Error("failed-upload-s3");return o.$metadata.requestId})}initMultipartUpload(t,e){return u(this,null,function*(){const r=E({credentials:S("default"),region:"us-east-2"}),n=new p.CreateMultipartUploadCommand({Bucket:t,ContentEncoding:"utf8",ContentType:"text/csv",Key:e}),i=yield r.send(n);if(i.UploadId===void 0||i.$metadata.httpStatusCode!==200)throw new Error("failed-multipart-upload");if(i.UploadId===void 0)throw new Error("failed-multipart-upload");return i.UploadId})}exec(t,e){if(console.log(`exec: ${t} ${e.join(" ")}`),this.pcount>5)throw new Error(`too-many-processes: ${this.pcount}`);return this.pcount++,(0,C.spawn)(t,e,{})}promisifyProcessResult(t){return u(this,null,function*(){const e={stdout:"",stderr:"",code:0};return yield new Promise((r,n)=>{t.stdout.on("data",i=>{e.stdout+=i}),t.on("close",i=>{e.code=i===0?0:1,r(e)}),t.on("error",i=>{n(i)})})})}}function L(s){return u(this,null,function*(){return yield new Promise((t,e)=>{(s.source===""||s.source===void 0)&&e(new Error("invalid-source: the source path is required")),s.destination===""&&e(new Error("failed-to-create-dataset: destination is required")),s.source.endsWith(".csv")||e(new Error(`invalid-file-type: expected a .csv file, ${s.source} is not`));const r=new B(s);Promise.all([r.determineEnv(),r.determineShape(),r.determineConnector(),r.determineLoader(),r.headerColumn(),r.fileSize(),r.rowCount()]).then(()=>{console.log(`created catalog for: ${s.name}`),t(r)}).catch(n=>e(n))})})}class j{constructor(t){this.name=t,this.catalogs=new Map,this.createdAt=new Date,this.env="local",this.stmt=""}list(){return Array.from(this.catalogs.values())}remove(t){this.catalogs.delete(t.options.source)}get(t){if(this.catalogs.get(t)!=null)return this.catalogs.get(t)}add(t){if(Array.isArray(t)){if(t.length===1&&t[0].name!==""){const e=t[0];if(this.catalogs.has(e.name))throw new Error(`duplicate-dataset: ${e.name}`);return this.catalogs.set(e.name,e),e.name}return t.forEach(e=>{if(this.catalogs.has(e.name))throw new Error(`duplicate-dataset: ${e.name}`);console.log(`added ${e.name} to the workflow`),this.catalogs.set(e.name,e)}),t.map(e=>e.name)}if(this.catalogs.has(t.name))throw new Error(`duplicate-dataset: ${t.name}`);return this.catalogs.set(t.name,t),console.log(`added ${t.name} to the workflow`),t.name}promisifyProcessResult(t){return u(this,null,function*(){const e={stdout:"",stderr:"",code:0};return yield new Promise((r,n)=>{t.stdout.on("data",i=>{e.stdout+=i}),t.on("close",i=>{e.code=i===0?0:1,r(e)}),t.on("error",i=>{n(i)})})})}exec(t,e){return u(this,null,function*(){const r=(0,C.spawn)(t,e),n={stdout:"",stderr:"",code:0};return yield new Promise((i,a)=>{r.stdout.on("data",c=>{n.stdout+=c}),r.on("close",c=>{n.code=c===0?0:1,i(n)}),r.on("error",c=>{a(c)})})})}query(t){return u(this,null,function*(){let e="";const r=new U().parse(t);if(r.from.length===1&&(e=r.from[0].relname),console.log(`raw query: ${t}`),console.log(JSON.stringify(r,null,2)),!this.catalogs.has(e))throw new Error(`unknown-catalog: ${e}`);const n=this.catalogs.get(e);if(n==null)throw new Error(`catalog-not-found: ${e}`);console.log(`querying catalog: ${n.name}`);const i=new D(n,r).analyze();console.log(JSON.stringify(i,null,2))})}}function J(s){return console.log(`created workflow: ${s}`),new j(s)}class U{constructor(){this.query="",this.stmt={type:"",distinct:!1,columns:[{name:"",type:""}],from:[{schemaname:"",relname:"",inh:""}],sort:{},where:{},group:[],having:[],orderBy:[],limit:{type:"",val:""}}}parse(t){var i,a,c;if(t.trim()==="")throw new Error("invalid-query: no query found");const r=(0,R.parse)(t)[0].RawStmt.stmt.SelectStmt,n=r.limitOption;if(n==="LIMIT_OPTION_DEFAULT"&&(this.stmt.limit={type:r.limitOption,val:""}),n==="LIMIT_OPTION_COUNT"&&r.limitCount!==""&&(this.stmt.limit={type:r.limitOption,val:r.limitCount.A_Const.val.Integer.ival}),r.distinctClause!==void 0&&(this.stmt.distinct=!0),r.targetList!==void 0&&(this.stmt.columns=r.targetList.map(o=>{const l=o.ResTarget.val.ColumnRef.fields[0];return l.A_Star!==void 0?{name:"*"}:o.ResTarget.name!==void 0?{as:o.ResTarget.name,name:l.String.str}:{name:l.String.str}})),this.stmt.from=r.fromClause.map(o=>{const l={schemaname:"",relname:"",inh:""},d=o.RangeVar;return d.schemaname!==void 0&&(l.schemaname=d.schemaname),d.relname!==void 0&&(l.relname=d.relname),d.inh!==void 0&&(l.inh=d.inh),l}),r.whereClause!==void 0){if(r.whereClause!==null&&((i=r==null?void 0:r.whereClause)==null?void 0:i.A_Expr.kind)==="AEXPR_OP"){const o=r.whereClause.A_Expr,l={operator:"",left:{},right:{}};l.operator=o.name[0].String.str,o.lexpr!==null&&(l.left=o.lexpr.ColumnRef.fields[0].String.str),o.rexpr!==null&&(l.right=o.rexpr.ColumnRef.fields[0].String.str),this.stmt.where=l}if(((a=r==null?void 0:r.whereClause)==null?void 0:a.A_Expr)!==null&&((c=r==null?void 0:r.whereClause)==null?void 0:c.A_Expr.kind)==="AEXPR_IN"){const o=r.whereClause.A_Expr;console.log(o)}if(r.whereClause.BoolExpr!==null){if(r.whereClause.BoolExpr.boolop==="AND_EXPR"){const o=r.whereClause.BoolExpr.args;console.log(JSON.stringify(o,null,2))}if(r.whereClause.BoolExpr.boolop==="OR_EXPR"){const o=r.whereClause.BoolExpr.args;console.log(JSON.stringify(o,null,2))}}}return this.stmt}}class D{constructor(t,e){this.stmt=e,this.catalog=t,this.plan={name:"beepboop"}}analyze(){return console.log("analyzing query"),this.plan}}module.exports=q(V);0&&(module.exports={createCatalog,createWorkflow});
