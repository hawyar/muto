var J=(s,e,t)=>{if(!e.has(s))throw TypeError("Cannot "+t)};var g=(s,e,t)=>{if(e.has(s))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(s):e.set(s,t)};var h=(s,e,t)=>(J(s,e,"access private method"),t);var v=(s,e,t)=>new Promise((n,r)=>{var i=c=>{try{a(t.next(c))}catch(p){r(p)}},o=c=>{try{a(t.throw(c))}catch(p){r(p)}},a=c=>c.done?n(c.value):Promise.resolve(c.value).then(i,o);a((t=t.apply(s,e)).next())});import*as d from"fs";import*as x from"os";import{createInterface as N}from"readline";import{spawn as P}from"child_process";import{fromIni as R}from"@aws-sdk/credential-providers";import*as $ from"fastq";import U from"path";import{readFileSync as m,writeFileSync as S}from"atomically";import{S3Client as A,GetObjectCommand as q,CreateMultipartUploadCommand as T}from"@aws-sdk/client-s3";var j=s=>R({profile:s,mfaCodeProvider:e=>v(void 0,null,function*(){return e})}),M=class{constructor({source:e,options:t}){this.source=e,this.options=t,this.createdAt=new Date,this.state="init"}},te=function(){let s;function e(t){return v(this,null,function*(){console.log(t)})}return{getInstance:()=>(s||(s=$.promise(e,10)),s)}}(),L=function(){let s;function e(){let t=U.join(process.cwd(),".muto-cache");return d.existsSync(t)||S(t,JSON.stringify({})),{init:new Date,path:t,get:n=>{let r=m(t),i=JSON.parse(r.toString());if(i[n].source===n)return i[n]},set:(n,r)=>{let i=m(t),o=JSON.parse(i.toString());return o[n]=r,S(t,JSON.stringify(o)),n},has:n=>{let r=m(t);return JSON.parse(r.toString())[n].source===n},delete:n=>{let r=m(t),i=JSON.parse(r.toString());delete i[n],S(t,JSON.stringify(i))},clear:()=>{S(t,JSON.stringify({}))},size:()=>{let n=m(t),r=JSON.parse(n.toString());return Object.keys(r).length},keys:()=>{let n=m(t),r=JSON.parse(n.toString());return Object.keys(r)}}}return{getInstance:()=>(s||(s=e()),s)}}();function B(s){return Object.freeze({readStream(){return new Promise((e,t)=>{let n=d.createReadStream(s);n.on("error",r=>{t(r)}),n.on("open",()=>{e(n)})})},writeStream(){return new Promise((e,t)=>{let n=d.createWriteStream(s);n.on("error",r=>{t(r)}),n.on("open",()=>{e(n)})})}})}var C,ne,y,F,D,re,w,z,O,ie,k,se,I,oe,b,H,W=class{constructor(e){g(this,C);g(this,y);g(this,D);g(this,w);g(this,O);g(this,k);g(this,I);g(this,b);this.name=e,this.datasets=new Map,this.createdAt=new Date,this.env="local",this.lcache=L.getInstance()}list(){return Array.from(this.datasets.values())}remove(e){this.datasets.delete(e.source)}add(e,t){return new Promise((n,r)=>{if(t.destination===""&&console.warn(`dataset-source-not-provided: Dataset ${e} does not have a destination`),this.lcache.has(e)){console.log("cache hit");let o=this.lcache.get(e);n(e)}if(h(this,y,F).call(this,e)==="local"){let o=B(e),a=new M({source:e,options:t});this.lcache.set(e,a),n(e)}})}};C=new WeakSet,ne=function(e){let{data:t,err:n}=h(this,b,H).call(this,e,{file:!0});if(n||!t.file)return console.error(`Invalid S3 URI: ${e}, URI must point to a file`),!1;let r=h(this,w,z).call(this,{credentials:j("default"),region:"us-east-2"}),i=new q({Bucket:t.bucket,Key:t.file});return r.send(i).then(o=>o.$metadata.httpStatusCode===200&&o.ContentType==="text/csv").catch(o=>(console.error(o),!1)),!1},y=new WeakSet,F=function(e){if(e.startsWith("/")||e.startsWith("../")||e.startsWith("./"))return"local";if(e.startsWith("s3://"))return"s3";throw new Error(`invalid-source-type: ${e}`)},D=new WeakSet,re=function(e){return d.createReadStream(e)},w=new WeakSet,z=function(e){return e.region||(e.region="us-east-2"),new A(e)},O=new WeakSet,ie=function(e){let t={type:"",columns:[""],header:!1,encoding:"utf-8",bom:!1,spanMultipleLines:!1,quotes:!1,delimiter:",",errors:{},warnings:{},preview:[[""]]};if(!d.existsSync(e))throw new Error(`${e} does not exist, provide a valid path to a CSV file`);if(x.platform()==="win32")return console.error("handle windows later"),t;let n=P("file",[e,"--mime-type"]);n.stdout.on("data",f=>{let l=f.toString().split(":")[1].trim();l==="text/csv"||l==="text/plain"?t.type=l:t.errors.incorrectType=`${e} is not a CSV file`}),n.on("close",f=>{(f!==0||t.type==="")&&console.warn("unable to use file() cmd")});let r=N({input:d.createReadStream(e),crlfDelay:1/0}),i=0,o=20,a={row:[""],del:""},c="",p=[",",";","	","|",":"," ","|"];return r.on("line",f=>{if(i===0){p.forEach(u=>{f.split(u).length>1&&(a.row=f.split(u),a.del=u)}),(a.del===""||a.row.length<=1)&&(t.errors.unrecognizedDelimiter=`${e} does not have a recognized delimiter`,t.header=!1);let l=/\d+/;if(a.row.some(u=>l.test(u))){t.header=!1,t.warnings.noHeader="no header found",i++;return}t.header=!0,t.delimiter=a.del,t.columns=a.row}if(i>0&&i<o){let l=f.split('"').length-1;if(c&&l%2!==0&&(t.spanMultipleLines=!0),l%2!==0&&f.split('""').length-1!==1&&(c=f),f.split(a.del).length!==a.row.length){t.errors.rowWidthMismatch="row width mismatch";return}t.preview.push(f.split(a.del))}i++}),t},k=new WeakSet,se=function(e){let t=1024*1024*50;if(!d.existsSync(e))throw new Error(`path-doesnt-exists: ${e} ,provide a valid path to a CSV file`);if(d.statSync(e).size>t)throw new Error(`file-size-exceeds-limit: ${e} is too large, please limit to 50MB`);return d.statSync(e).size},I=new WeakSet,oe=function(e,t,n){return new Promise((r,i)=>{try{let o=h(this,w,z).call(this,{credentials:j("default"),region:"us-east-2"});if(!(o instanceof A))throw new Error(`invalid-operation: Invalid operation for ${e.source}`);let a=new T({Bucket:t,ContentEncoding:"utf8",ContentType:"text/csv",Key:n});o.send(a).then(c=>{c.UploadId&&r(c.UploadId),i(new Error("noop"))}).catch(c=>{i(c)}).finally(()=>{console.log("init multipart upload")})}catch(o){i(o)}})},b=new WeakSet,H=function(e,t){let n={file:t&&t.file?t.file:!1};if(!e.startsWith("s3://")||e.split(":/")[0]!=="s3")throw new Error(`invalid-s3-uri: ${e}`);let r="",i={bucket:"",key:"",file:""},o=e.split(":/")[1],[a,...c]=o.split("/").splice(1);return i.bucket=a,i.key=c.join("/"),c.forEach((p,f)=>{if(f===c.length-1){let l=p.split(".").length;if(n.file&&l===1&&(r=`uri should be a given, given: ${e}`),!n.file&&l===1)return;if(!n.file&&l>1){r=`Invalid S3 uri, ${e} should not end with a file name`;return}!n.file&&p.split(".")[1]!==""&&l>1&&(r=`${e} should not be a file endpoint: ${p}`),l>1&&p.split(".")[1]!==""&&(i.file=p)}}),{data:i,err:r}};function V(s){return new W(s)}export{V as createWorkflow};
//# sourceMappingURL=muto.js.map
