var W=Object.create;var y=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var I=Object.getPrototypeOf,z=Object.prototype.hasOwnProperty;var P=o=>y(o,"__esModule",{value:!0});var T=(o,t)=>{for(var e in t)y(o,e,{get:t[e],enumerable:!0})},x=(o,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of N(t))!z.call(o,s)&&(e||s!=="default")&&y(o,s,{get:()=>t[s],enumerable:!(r=A(t,s))||r.enumerable});return o},E=(o,t)=>x(P(y(o!=null?W(I(o)):{},"default",!t&&o&&o.__esModule?{get:()=>o.default,enumerable:!0}:{value:o,enumerable:!0})),o),_=(o=>(t,e)=>o&&o.get(t)||(e=x(P({}),t,1),o&&o.set(t,e),e))(typeof WeakMap!="undefined"?new WeakMap:0);var d=(o,t,e)=>new Promise((r,s)=>{var n=i=>{try{c(e.next(i))}catch(l){s(l)}},a=i=>{try{c(e.throw(i))}catch(l){s(l)}},c=i=>i.done?r(i.value):Promise.resolve(i.value).then(n,a);c((e=e.apply(o,t)).next())});var V={};T(V,{createCatalog:()=>q,createWorkflow:()=>J});var h=E(require("fs"),1),C=require("child_process"),$=E(require("os"),1),g=E(require("path"),1),b=require("vfile"),R=require("pgsql-parser"),O=require("readline"),p=require("@aws-sdk/client-s3"),k=require("@aws-sdk/credential-providers");const w=(0,g.join)(process.cwd(),"node_modules",".bin","mlr@v6.0.0");var M=(a=>(a.COMMA=",",a.TAB="	",a.SPACE=" ",a.PIPE="|",a.SEMICOLON=";",a.COLON=":",a))(M||{});function j(o){var n,a,c;const e=(0,R.parse)(o)[0].RawStmt.stmt.SelectStmt,r={type:"select",distinct:!1,columns:[],from:[],sort:{},where:{},group:[],having:[],order:[],limit:{type:"",val:""}},s=e.limitOption;if(s==="LIMIT_OPTION_DEFAULT"&&(r.limit={type:e.limitOption,val:""}),s==="LIMIT_OPTION_COUNT"&&e.limitCount!==""&&(r.limit={type:e.limitOption,val:e.limitCount.A_Const.val.Integer.ival}),e.distinctClause!==void 0&&(r.distinct=!0),e.targetList!==void 0&&(r.columns=e.targetList.map(i=>{const l=i.ResTarget.val.ColumnRef.fields[0];return l.A_Star!==void 0?{name:"*"}:i.ResTarget.name!==void 0?{as:i.ResTarget.name,name:l.String.str}:{name:l.String.str}})),r.from=e.fromClause.map(i=>{const l={schemaname:"",relname:"",inh:""},u=i.RangeVar;return u.schemaname!==void 0&&(l.schemaname=u.schemaname),u.relname!==void 0&&(l.relname=u.relname),u.inh!==void 0&&(l.inh=u.inh),l}),e.whereClause!==void 0){if(e.whereClause!==null&&((n=e==null?void 0:e.whereClause)==null?void 0:n.A_Expr.kind)==="AEXPR_OP"){const i=e.whereClause.A_Expr,l={operator:"",left:{},right:{}};l.operator=i.name[0].String.str,i.lexpr!==null&&(l.left=i.lexpr.ColumnRef.fields[0].String.str),i.rexpr!==null&&(l.right=i.rexpr.ColumnRef.fields[0].String.str),r.where=l}if(((a=e==null?void 0:e.whereClause)==null?void 0:a.A_Expr)!==null&&((c=e==null?void 0:e.whereClause)==null?void 0:c.A_Expr.kind)==="AEXPR_IN"){const i=e.whereClause.A_Expr;console.log(i)}if(e.whereClause.BoolExpr!==null){if(e.whereClause.BoolExpr.boolop==="AND_EXPR"){const i=e.whereClause.BoolExpr.args;console.log(JSON.stringify(i,null,2))}if(e.whereClause.BoolExpr.boolop==="OR_EXPR"){const i=e.whereClause.BoolExpr.args;console.log(JSON.stringify(i,null,2))}}}return r}const S=o=>(0,k.fromIni)({profile:o,mfaCodeProvider:t=>d(void 0,null,function*(){return t})});function v(o){return new p.S3Client(o)}function L(o,t){const e={file:t.file?t.file:!1};if(!o.startsWith("s3://")||o.split(":/")[0]!=="s3")throw new Error(`invalid-s3-uri: ${o}`);let r="";const s={bucket:"",key:"",file:""},n=o.split(":/")[1],[a,...c]=n.split("/").splice(1);return s.bucket=a,s.key=c.join("/"),c.forEach((i,l)=>{if(l===c.length-1){const u=i.split(".").length;if(e.file&&u===1&&(r=`uri should be a given, given: ${o}`),!e.file&&u===1)return;if(!e.file&&u>1){r=`Invalid S3 uri, ${o} should not end with a file name`;return}!e.file&&i.split(".")[1]!==""&&u>1&&(r=`${o} should not be a file endpoint: ${i}`),u>1&&i.split(".")[1]!==""&&(s.file=i)}}),{data:s,err:r}}class B{constructor(t,e){this.name=e.name!==""?e.name:g.default.basename(t),this.source=t,this.options=e,this.destination=e.destination,this.env="local",this.init=new Date,this.state="init",this.pcount=0,this.columns=[],this.connector=null,this.loader=null,this.vfile=new b.VFile({path:this.source}),this.stmt={type:"",distinct:!1,columns:[],from:[],sort:[],where:{},group:[],having:[],limit:{type:"",val:""}}}toJson(){return d(this,null,function*(){return this.exec(w,["--icsv","--ojson","clean-whitespace",this.source,">",this.destination])})}rowCount(){return d(this,null,function*(){const t=yield this.exec(w,["--ojson","count",this.source]),e=yield this.promisifyProcessResult(t);if(e.code!==0)throw new Error(`Error while counting rows: ${e.stderr}`);if(e.stderr!=="")throw new Error(e.stderr);const r=JSON.parse(e.stdout);if(r.length===0)throw new Error("Error while counting rows");if(r[0].count===void 0)throw new Error("Error while counting rows");return r[0].count})}headerColumn(){return d(this,null,function*(){const t=yield this.exec(w,["--icsv","--ojson","head","-n","1",this.source]),e=yield this.promisifyProcessResult(t);if(e.code!==0)throw new Error(`Error while getting column header: ${e.stderr}`);const r=JSON.parse(e.stdout);if(r.length===0)throw new Error("No columns found");this.columns=Object.keys(r[0])})}preview(t=20,e){return d(this,null,function*(){if(e===void 0)throw new Error("stream-destination-undefined");if(e!==null&&e!==this.source&&h.default.createWriteStream(e)instanceof h.default.WriteStream){const n=h.default.createWriteStream(e);return(yield this.exec(w,["--icsv","--ojson","head","-n",t.toString(),this.source])).stdout.pipe(n),console.warn(`preview saved to: ${e}`),e}const r=yield this.exec(w,["--icsv","--ojson","head","-n",t.toString(),this.source]),s=yield this.promisifyProcessResult(r);if(s.stderr!=="")throw new Error(s.stderr);if(s.code!==0)throw new Error("Error while executing mlr command");return this.vfile.data.preview=JSON.parse(s.stdout),JSON.parse(s.stdout)})}determineShape(){return d(this,null,function*(){const t=this.source,e={type:"",size:0,columns:[],header:!1,encoding:"utf-8",bom:!1,spanMultipleLines:!1,quotes:!1,delimiter:",",errors:{},warnings:{},preview:[]};if(!h.default.existsSync(t))throw new Error(`path-doesnt-exists: ${t} ,provide a valid path to a CSV file`);if(e.size=h.default.statSync(t).size,e.size>1024*1024*1024)throw new Error(`file-size-exceeds-limit: ${t} is too large, please limit to under 1GB for now`);if(!h.default.existsSync(t))throw new Error(`${t} does not exist, provide a valid path to a CSV file`);if($.default.platform()==="win32")throw new Error("scream");const r=this.exec("file",[t,"--mime-type"]),s=yield this.promisifyProcessResult(r);if(s.stderr!=="")throw new Error(`failed-to-detect-mime-type: ${s.stderr}`);if(s.code!==0)throw new Error(`failed-to-detect-mime-type: ${s.stderr}`);e.type=s.stdout.split(":")[1].trim();const n=(0,O.createInterface)({input:h.default.createReadStream(t),crlfDelay:1/0});let a=0;const c=20,i={row:[""],del:""};let l="";const u=[",",";","	","|",":"," ","|"];n.on("line",m=>{if(a===0&&(u.forEach(f=>{m.split(f).length>1&&(i.row=m.split(f),i.del=f)}),(i.del===""||i.row.length<=1)&&(e.errors.unrecognizedDelimiter=`${t} does not have a recognized delimiter`,e.header=!1),i.row.forEach(f=>{isNaN(parseInt(f.substring(0,3)))||(e.header=!1,e.warnings.noHeader="no header found",a++)}),e.header=!0,e.delimiter=i.del,e.columns=i.row),a>0&&a<c){const f=m.split('"').length-1;if(l!==""&&f%2!==0&&(e.spanMultipleLines=!0),f%2!==0&&m.split('""').length-1!==1&&(l=m),m.split(i.del).length!==i.row.length){e.errors.rowWidthMismatch="row width mismatch";return}e.preview.push(m.split(i.del))}a++}),n.on("close",()=>{this.vfile.data.shape=e})})}determineLoader(){if(this.destination.startsWith("s3://")){this.loader=v({credentials:S("default"),region:"us-east-2"});return}(this.source.startsWith("/")||this.source.startsWith("../")||this.source.startsWith("./"))&&(this.loader=h.default.createReadStream(this.source))}determineConnector(){switch(this.env){case"local":if(!h.default.existsSync(this.source))throw new Error(`file: ${this.source} not found, please provide a valid file path`);this.connector=h.default.createReadStream(this.source);break;case"aws":this.connector=v({credentials:S("default"),region:"us-east-2"});break;default:throw new Error(`unsupported-source for: ${this.source}`)}}determineEnv(){if(this.source.startsWith("/")||this.source.startsWith("../")||this.source.startsWith("./")){this.env="local";return}if(this.source.startsWith("s3://")){this.env="aws";return}throw new Error(`invalid-source-type: ${this.source}`)}fileSize(){return d(this,null,function*(){const t=50*1024*1024,e=yield h.default.promises.stat(this.source);if(e.size>t)throw new Error(`file-size-exceeds-limit: ${this.source} is too large, please limit to under 50MB for now`);return this.vfile.data.size=e.size,e.size})}uploadToS3(){return d(this,null,function*(){if(this.source==="")throw new Error("source not definded");if(this.destination==="")throw new Error("destination not definded");const t=h.default.createReadStream(this.source);if(!t.readable)throw new Error("failed-to-read-source: Make sure the provided file is readable");const e=yield this.fileSize();e>100*1024*1024&&console.warn(`file size ${e} is larger`);const{data:r,err:s}=L(this.destination,{file:!0});if(s.toString().startsWith("invalid-s3-uri"))throw new Error(`failed-to-parse-s3-uri: ${s}`);r.file===""&&(r.file=g.default.basename(this.source),console.warn("Destination filename not provided. Using source source basename"+r.file)),console.log(`uploading ${this.source} to ${this.destination}`);const a=yield v({region:"us-east-2"}).send(new p.PutObjectCommand({Bucket:r.bucket,Key:r.key+r.file,Body:t})).catch(c=>{throw new Error(`failed-upload-s3: Error while uploading to S3: ${c}`)}).finally(()=>{t.close()});if(a.$metadata.httpStatusCode!==void 0&&a.$metadata.httpStatusCode!==200)throw new Error(`failed-upload-s3: Error while uploading to S3: ${a.$metadata.httpStatusCode}`);if(a.$metadata.requestId===void 0)throw new Error("failed-upload-s3");return a.$metadata.requestId})}initMultipartUpload(t,e){return d(this,null,function*(){const r=v({credentials:S("default"),region:"us-east-2"}),s=new p.CreateMultipartUploadCommand({Bucket:t,ContentEncoding:"utf8",ContentType:"text/csv",Key:e}),n=yield r.send(s);if(n.UploadId===void 0||n.$metadata.httpStatusCode!==200)throw new Error("failed-multipart-upload");if(n.UploadId===void 0)throw new Error("failed-multipart-upload");return n.UploadId})}exec(t,e){if(console.log(`exec: ${t} ${e.join(" ")}`),this.pcount>5)throw new Error(`too-many-processes: ${this.pcount}`);return this.pcount++,(0,C.spawn)(t,e,{})}promisifyProcessResult(t){return d(this,null,function*(){const e={stdout:"",stderr:"",code:0};return yield new Promise((r,s)=>{t.stdout.on("data",n=>{e.stdout+=n}),t.on("close",n=>{e.code=n===0?0:1,r(e)}),t.on("error",n=>{s(n)})})})}}function q(o,t){return d(this,null,function*(){return yield new Promise((e,r)=>{o===""&&r(new Error("invalid-source: the source path is required")),t.destination===""&&r(new Error("failed-to-create-dataset: destination is required")),o.endsWith(".csv")||r(new Error(`invalid-file-type: expected a .csv file, ${o} is not`));const s=new B(o,t);Promise.all([s.determineEnv(),s.determineShape(),s.determineConnector(),s.determineLoader(),s.headerColumn(),s.fileSize(),s.rowCount()]).then(()=>{console.log(`created catalog for ${o}`),e(s)}).catch(n=>r(n))})})}class U{constructor(t){this.name=t,this.catalogs=new Map,this.createdAt=new Date,this.env="local",this.stmt=""}list(){return Array.from(this.catalogs.values())}remove(t){this.catalogs.delete(t.source)}get(t){if(this.catalogs.get(t)!=null)return this.catalogs.get(t)}add(t){if(Array.isArray(t)){if(t.length===1&&t[0].name!==""){const e=t[0];if(this.catalogs.has(e.name))throw new Error(`duplicate-dataset: ${e.name}`);return this.catalogs.set(e.name,e),e.name}return t.forEach(e=>{if(this.catalogs.has(e.name))throw new Error(`duplicate-dataset: ${e.name}`);console.log(`added ${e.name} to the workflow`),this.catalogs.set(e.name,e)}),t.map(e=>e.name)}if(this.catalogs.has(t.name))throw new Error(`duplicate-dataset: ${t.name}`);return this.catalogs.set(t.name,t),console.log(`added ${t.name} to the workflow`),t.name}promisifyProcessResult(t){return d(this,null,function*(){const e={stdout:"",stderr:"",code:0};return yield new Promise((r,s)=>{t.stdout.on("data",n=>{e.stdout+=n}),t.on("close",n=>{e.code=n===0?0:1,r(e)}),t.on("error",n=>{s(n)})})})}exec(t,e){return d(this,null,function*(){const r=(0,C.spawn)(t,e),s={stdout:"",stderr:"",code:0};return yield new Promise((n,a)=>{r.stdout.on("data",c=>{s.stdout+=c}),r.on("close",c=>{s.code=c===0?0:1,n(s)}),r.on("error",c=>{a(c)})})})}query(t){return d(this,null,function*(){const e=j(t);let r="";if(e.from.length===1&&(r=e.from[0].relname),!this.catalogs.has(r))throw new Error(`unknown-catalog: ${r}`);const s=this.catalogs.get(r);if(s==null)throw new Error(`catalog-not-found: ${r}`);if(console.log(`querying catalog: ${s.name}`),e.columns[0].name==="*"&&console.log("columns: *"),e.columns.length>1){console.log("columns: ",e.columns.map(a=>a.name).join(", "));const n=e.columns.map(a=>a.name).join(",");yield this.exec(w,["--icsv","--ojson","cut","-f",n,s.source,">",s.destination])}})}}function J(o){return console.log(`created workflow: ${o}`),new U(o)}module.exports=_(V);0&&(module.exports={createCatalog,createWorkflow});
