#!/usr/bin/env node
var g=(t,e,i)=>new Promise((a,n)=>{var o=r=>{try{s(i.next(r))}catch(l){n(l)}},m=r=>{try{s(i.throw(r))}catch(l){n(l)}},s=r=>r.done?a(r.value):Promise.resolve(r.value).then(o,m);s((i=i.apply(t,e)).next())});import L from"arg";import C,{join as S}from"path";import w from"os";import h from"fs";import{exec as _}from"child_process";import{fromIni as $}from"@aws-sdk/credential-providers";import{S3Client as O}from"@aws-sdk/client-s3";import j from"util";import{exec as W}from"child_process";import{parse as q}from"pgsql-parser";import{join as I}from"path";var d=(t,e,i)=>new Promise((a,n)=>{var o=r=>{try{s(i.next(r))}catch(l){n(l)}},m=r=>{try{s(i.throw(r))}catch(l){n(l)}},s=r=>r.done?a(r.value):Promise.resolve(r.value).then(o,m);s((i=i.apply(t,e)).next())}),v=t=>$({profile:t,mfaCodeProvider:e=>d(void 0,null,function*(){return e})});function y(t){return new O(t)}var p=j.promisify(_),x=S(process.cwd(),"node_modules",".bin","mlr@v6.0.0"),R=class{constructor(t){this.name=t.name!==""?t.name:C.basename(t.source),this.options=t,this.env="local",this.createdAt=new Date,this.state="init",this.connector=null,this.loader=null,this.metadata={type:"",columns:[],header:!1,extension:"",size:0,rowCount:0,spanMultipleLines:!1,quotes:!1,delimiter:",",errors:{},warnings:{}}}rowCount(){return d(this,null,function*(){let t=yield p(`${x} --ojson count ${this.options.source}`);if(t.stderr!=="")throw new Error(`failed-to-get-row-count: ${t.stderr}`);let e=JSON.parse(t.stdout);if(e.length===0)throw new Error("failed-to-get-row-count: no rows found");if(e[0].count===void 0)throw new Error("failed-to-get-row-count: no count found");this.metadata.rowCount=e[0].count})}headerColumn(){return d(this,null,function*(){let t=yield p(`${x} --icsv --ojson head -n 1 ${this.options.source}`);if(t.stderr!=="")throw new Error(`failed-to-get-header-column: ${t.stderr}`);console.log(t);let e=JSON.parse(t.stdout);if(e.length===0)throw new Error("failed-to-get-header-column: no columns found");this.metadata.columns=Object.keys(e[0])})}fileType(){return d(this,null,function*(){if(w.platform()!=="linux"&&w.platform()!=="darwin")throw new Error("unsupported-platform");let t=yield p(`file ${this.options.source} --mime-type`);if(t.stderr!=="")throw new Error(`failed-to-detect-mime-type: ${t.stderr}`);let e=t.stdout.split(":")[1].trim();if(e==="")throw new Error("failed-to-detect-mime-type");this.options.source.endsWith(".csv")&&(this.metadata.extension="csv"),this.options.source.endsWith(".json")&&(this.metadata.extension="json"),this.metadata.type=e})}fileSize(){return d(this,null,function*(){let t=yield h.promises.stat(this.options.source);this.metadata.size=t.size})}determineLoader(){if(this.options.destination.startsWith("s3://")){this.loader=y({credentials:v("default"),region:"us-east-2"});return}if(this.options.source.startsWith("/")||this.options.source.startsWith("../")||this.options.source.startsWith("./")){this.loader=h.createWriteStream(this.options.destination);return}throw new Error("unsupported-loader")}determineConnector(){if(this.options.source.startsWith("/")||this.options.source.startsWith("../")||this.options.source.startsWith("./")){if(!h.existsSync(this.options.source))throw new Error(`file: ${this.options.source} not found, please provide a valid file path`);this.connector=h.createReadStream(this.options.source);return}if(this.options.source.startsWith("s3://")){this.connector=y({credentials:v("default"),region:"us-east-2"});return}throw new Error(`unsupported-source for: ${this.options.source}`)}};function P(t,e){return d(this,null,function*(){return yield new Promise((i,a)=>{(e.source===""||e.source===void 0)&&a(new Error("failed-to-create-catalog: no source provided")),(e.destination===""||e.destination===void 0)&&a(new Error("failed-to-create-catalog: no destination provided")),(e.name===""||e.name===void 0)&&a(new Error("failed-to-create-catalog: no name provided")),e.input==="csv"&&!e.source.endsWith(".csv")&&a(new Error("failed-to-create-catalog: file extension does not match input type")),e.input==="json"&&!e.source.endsWith(".json")&&a(new Error("failed-to-create-catalog: file extension does not match input type"));let n=new R(e);Promise.all([n.determineConnector(),n.determineLoader(),n.headerColumn(),n.fileSize(),n.fileType(),n.rowCount()]).then(()=>{console.log(`created catalog for: ${e.name}`),i(n)}).catch(o=>a(o))})})}var A=class{constructor(){this.query="",this.stmt={type:"",distinct:!1,columns:[{name:"",type:""}],from:[{schemaname:"",relname:"",inh:""}],sort:{},where:{},group:[],having:[],orderBy:[],limit:{type:"",val:""}}}parse(t){var e,i,a;if(t.trim()==="")throw new Error("invalid-query: no query found");console.log(`raw: ${t}`);let n=q(t);Object.keys(n[0].RawStmt.stmt)[0]==="SelectStmt"&&(this.stmt.type="select");let o=n[0].RawStmt.stmt.SelectStmt,m=o.limitOption;if(m==="LIMIT_OPTION_DEFAULT"&&(this.stmt.limit={type:o.limitOption,val:""}),m==="LIMIT_OPTION_COUNT"&&o.limitCount!==""&&(this.stmt.limit={type:o.limitOption,val:o.limitCount.A_Const.val.Integer.ival}),o.distinctClause!==void 0&&(this.stmt.distinct=!0),o.targetList!==void 0&&(this.stmt.columns=o.targetList.map(s=>{let r=s.ResTarget.val.ColumnRef.fields[0];return r.A_Star!==void 0?{name:"*"}:{name:r.String.str}})),this.stmt.from=o.fromClause.map(s=>{let r={schemaname:"",relname:"",inh:""},l=s.RangeVar;return l.schemaname!==void 0&&(r.schemaname=l.schemaname),l.relname!==void 0&&(r.relname=l.relname),l.inh!==void 0&&(r.inh=l.inh),r}),o.whereClause!==void 0){if(o.whereClause!==null&&((e=o==null?void 0:o.whereClause)==null?void 0:e.A_Expr.kind)==="AEXPR_OP"){let s=o.whereClause.A_Expr,r={operator:"",left:{},right:{}};r.operator=s.name[0].String.str,s.lexpr!==null&&(r.left=s.lexpr.ColumnRef.fields[0].String.str),s.rexpr!==null&&(r.right=s.rexpr.ColumnRef.fields[0].String.str),this.stmt.where=r}if(((i=o==null?void 0:o.whereClause)==null?void 0:i.A_Expr)!==null&&((a=o==null?void 0:o.whereClause)==null?void 0:a.A_Expr.kind)==="AEXPR_IN"){let s=o.whereClause.A_Expr;console.log(s)}if(o.whereClause.BoolExpr!==null){if(o.whereClause.BoolExpr.boolop==="AND_EXPR"){let s=o.whereClause.BoolExpr.args;console.log(JSON.stringify(s,null,2))}if(o.whereClause.BoolExpr.boolop==="OR_EXPR"){let s=o.whereClause.BoolExpr.args;console.log(JSON.stringify(s,null,2))}}}return this.stmt}};function N(t){return new A().parse(t)}var b=I(process.cwd(),"node_modules",".bin","mlr@v6.0.0");function E(t,e){return d(this,null,function*(){let i=N(t),a=yield P(t,e);if(a==null)throw new Error("failed-to-create-catalog");console.log(`created catalog for: ${a.name}`);let n=new T(a,i).analyze();console.log(`plan: ${JSON.stringify(n,null,2)}`);let{stdout:o,stderr:m}=W(n.cmd+" "+n.args.join(" "));console.log(`stdout: ${o}`),console.log(`stderr: ${m}`)})}var T=class{constructor(t,e){this.stmt=e,this.catalog=t,this.plan={cmd:"",args:[]}}analyze(){if(console.log("analyzing query"),this.plan.cmd=b,this.stmt.type!=="select")throw new Error("not-implemented: only select queries are supported at this time");if(console.log(this.stmt),this.stmt.from.length===1){let t=this.stmt.from[0].relname;console.log("from table: ",t);let e=this.catalog.options.source;if(this.stmt.columns.length===1){if(this.stmt.columns[0].name==="*")return this.plan.args=["--icsv","--ojson","cat",e],this.plan;this.plan.args=["--icsv","--ojson","cut","-f",this.stmt.columns[0].name,e]}if(this.stmt.columns.length>1){let i=this.stmt.columns.map(a=>a.name).join(",");return console.log("fields: ",i),this.plan.args=["--icsv","--ojson","cut","-o","-f",i,e],this.plan}}return this.plan}};var f=`
Usage: 

muto [command] [arg] [flags]

commands:
  query    Query data using SQL

flags:
  -v    --version       Print version
  -s    --source        Source path
  -d    --destination   Destination path
  -i    --input         Input format
  -o    --output        Output format
  -n    --name          Name of the query
`,u=L({"--help":Boolean,"--version":Boolean,"--source":String,"--destination":String,"--input":String,"--output":String,"--name":String,"-h":"--help","-v":"--version","-s":"--source","-d":"--destination","-i":"--input","-o":"--output","-n":"--name"});function z(){return g(this,null,function*(){u["--help"]&&(c(f),process.exit(0)),u["--version"]&&(c("v1.0.0"),process.exit(0)),u._.length===0&&(c(`Missing command 
${f}`),process.exit(1)),u._.length!==2&&(c(`Missing command ${f}`),process.exit(1)),u._[0]!=="query"&&c("Invalid command"),u["--source"]||(c("Missing source"),process.exit(1)),u["--destination"]||(c("Missing destination"),process.exit(1));let t={input:u["--input"]||"csv",output:u["--output"]||"csv",name:u["--name"]||"first_query",source:u["--source"],destination:u["--destination"]};u._[1]===""&&(c("Missing query"),process.exit(1)),yield E(u._[1],t),process.exit(0)})}function c(t){typeof t=="string"?process.stdout.write(`${t} 
`):process.stdout.write(`${JSON.stringify(t,null,2)}
`)}z().catch(console.error);process.on("unhandledRejection",(t,e)=>{c(t),process.exit(1)});
