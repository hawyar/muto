#!/usr/bin/env node
var v=(e,t,i)=>new Promise((a,o)=>{var c=s=>{try{r(i.next(s))}catch(d){o(d)}},n=s=>{try{r(i.throw(s))}catch(d){o(d)}},r=s=>s.done?a(s.value):Promise.resolve(s.value).then(c,n);r((i=i.apply(e,t)).next())});import N from"arg";import h,{join as C}from"path";import w from"os";import $ from"fs";import{exec as b}from"child_process";import E from"util";import{exec as j}from"child_process";import{parse as O}from"pgsql-parser";import{join as P}from"path";import{createWriteStream as R}from"fs";import{fromIni as Q}from"@aws-sdk/credential-providers";import{S3Client as V,HeadObjectCommand as G}from"@aws-sdk/client-s3";var f=(e,t,i)=>new Promise((a,o)=>{var c=s=>{try{r(i.next(s))}catch(d){o(d)}},n=s=>{try{r(i.throw(s))}catch(d){o(d)}},r=s=>s.done?a(s.value):Promise.resolve(s.value).then(c,n);r((i=i.apply(e,t)).next())}),g=E.promisify(b),y=C(process.cwd(),"node_modules",".bin","mlr@v6.0.0"),S=class{constructor(e){this.name=e.name!==""?e.name:h.basename(e.source),this.options=e,this.createdAt=new Date,this.metadata={type:"",columns:[],header:!1,extension:"",size:0,rowCount:0,spanMultipleLines:!1,quotes:!1,delimiter:",",errors:{},warnings:{}}}getName(){return this.name}getOptions(){return this.options}getMetadata(){return this.metadata}getColumns(){return this.metadata.columns}rowCount(){return f(this,null,function*(){let e=yield g(`${y} --ojson count ${this.options.source}`);if(e.stderr!=="")throw new Error(`failed-to-get-row-count: ${e.stderr}`);let t=JSON.parse(e.stdout);if(t.length===0)throw new Error("failed-to-get-row-count: no rows found");if(t[0].count===void 0)throw new Error("failed-to-get-row-count: no count found");this.metadata.rowCount=t[0].count})}columnHeader(){return f(this,null,function*(){let e=yield g(`${y} --icsv --ojson head -n 1 ${this.options.source}`);if(e.stderr!=="")throw new Error(`failed-to-get-header-column: ${e.stderr}`);let t=JSON.parse(e.stdout);if(t.length===0)throw new Error("failed-to-get-header-column: no columns found");this.metadata.columns=this.sanitizeColumnNames(Object.keys(t[0]))})}sanitizeColumnNames(e){return e.map(t=>t.replace(/[^a-zA-Z0-9]/g,"_"))}fileType(){return f(this,null,function*(){if(w.platform()!=="linux"&&w.platform()!=="darwin")throw new Error("unsupported-platform");let e=yield g(`file ${this.options.source} --mime-type`);if(e.stderr!=="")throw new Error(`failed-to-detect-mime-type: ${e.stderr}`);let t=e.stdout.split(":")[1].trim();if(t==="")throw new Error("failed-to-detect-mime-type");this.options.source.endsWith(".csv")&&(this.metadata.extension="csv"),this.options.source.endsWith(".json")&&(this.metadata.extension="json"),this.metadata.type=t})}fileSize(){return f(this,null,function*(){let e=yield $.promises.stat(this.options.source);this.metadata.size=e.size})}};function _(e,t){return f(this,null,function*(){return yield new Promise((i,a)=>{t===void 0&&a(new Error("missing-catalog-options")),(t.source===void 0||t.source==="")&&a(new Error("failed-to-create-catalog: no source provided")),(t.destination===void 0||t.destination==="")&&a(new Error("failed-to-create-catalog: no destination provided"));let o=Object.assign({},t);if((t.name===void 0||t.name==="")&&(o.name=h.basename(o.source).split(".")[0]),t.input===void 0){let n=h.extname(t.source)===".csv"?"csv":"json";console.warn(`no-input-type-provided: assuming ${n}`),o.input=n}if(t.output===void 0){let n=h.extname(t.destination)===".csv"?"csv":"json";console.warn(`no-output-type-provided: assuming ${n}`),o.output=n}let c=new S(o);Promise.all([c.columnHeader(),c.fileSize(),c.fileType(),c.rowCount()]).then(()=>{console.log(`created catalog: ${c.getName()}`),i(c)}).catch(n=>a(n))})})}var q=class{constructor(){this.query="",this.stmt={type:"",distinct:!1,columns:[{name:"",type:""}],from:[{schemaname:"",relname:"",inh:""}],sort:{},where:{},group:[],having:[],orderBy:[],limit:{type:"",val:""}}}parse(e){var t,i;if(e.trim()==="")throw new Error("invalid-query: no query found");let a=O(e);Object.keys(a[0].RawStmt.stmt)[0]==="SelectStmt"&&(this.stmt.type="select");let o=a[0].RawStmt.stmt.SelectStmt,c=o.limitOption;if(c==="LIMIT_OPTION_DEFAULT"&&(this.stmt.limit={type:o.limitOption,val:""}),c==="LIMIT_OPTION_COUNT"&&o.limitCount!==""&&(this.stmt.limit={type:o.limitOption,val:o.limitCount.A_Const.val.Integer.ival}),o.distinctClause!==void 0&&(this.stmt.distinct=!0),o.targetList!==void 0&&(this.stmt.columns=o.targetList.map(n=>{let r=n.ResTarget.val.ColumnRef.fields[0];return r.A_Star!==void 0?{name:"*"}:{name:r.String.str}})),o.fromClause!==void 0&&(this.stmt.from=o.fromClause.map(n=>{let r={schemaname:"",relname:"",inh:""},s=n.RangeVar;return s.schemaname!==void 0&&(r.schemaname=s.schemaname),s.relname!==void 0&&(r.relname=s.relname),s.inh!==void 0&&(r.inh=s.inh),r})),o.whereClause!==void 0){if(o.whereClause!==null&&((t=o==null?void 0:o.whereClause)==null?void 0:t.A_Expr.kind)==="AEXPR_OP"){let n=o.whereClause.A_Expr,r={operator:"",left:{},right:{}};r.operator=n.name[0].String.str,n.lexpr!==void 0&&(r.left=n.lexpr.ColumnRef.fields[0].String.str),n.rexpr!==void 0&&(n.rexpr.ColumnRef!==void 0&&Object.keys(n.rexpr.ColumnRef.fields[0]).includes("String")&&(r.right=n.rexpr.ColumnRef.fields[0].String.str),n.rexpr.A_Const!==void 0&&(r.right=n.rexpr.A_Const.val.Integer.ival)),this.stmt.where=r}o.whereClause.A_Expr!==void 0&&((i=o==null?void 0:o.whereClause)==null?void 0:i.A_Expr.kind)==="AEXPR_IN",o.whereClause.BoolExpr!==void 0&&(o.whereClause.BoolExpr.boolop==="AND_EXPR",o.whereClause.BoolExpr.boolop==="OR_EXPR")}return this.stmt}};function A(e){return new q().parse(e)}var z=P(process.cwd(),"node_modules",".bin","mlr@v6.0.0");function x(e,t){return f(this,null,function*(){let i=yield _(e,t);if(i==null)throw new Error("failed-to-create-catalog");let a=new I(i,A(e)).analyze();console.log(a.cmd+" "+a.args.join(" "));let{stdout:o}=j(a.cmd+" "+a.args.join(" "),{maxBuffer:1024*1024*1024});if(o===null)throw new Error("failed-to-execute-query");o.on("close",()=>{console.log("done executing query")}),o.pipe(R(i.options.destination))})}var I=class{constructor(e,t){this.stmt=t,this.catalog=e,this.plan={cmd:"",args:[]}}analyze(){if(console.log("analyzing query:"),this.plan.cmd=z,this.stmt.type!=="select")throw new Error("not-implemented: only select queries are supported at this time");if(this.stmt.from.length===1){let e=this.stmt.from[0].relname;console.log("	 table:",e);let t=this.catalog.options.source;if(this.stmt.columns.length===1){if(this.stmt.columns[0].name==="*")return this.plan.args=["--icsv","--ojson","--implicit-csv-header","label",`${this.catalog.metadata.columns.join(",")}`,t],this.plan;let i=this.stmt.columns[0].name.replace(/[^a-zA-Z0-9]/g,"_");if(!this.catalog.metadata.columns.includes(i))throw new Error(`column-not-found: ${i}`);return console.log("	 column:",i),this.plan.args=["--icsv","--ojson","--implicit-csv-header","label",`${this.catalog.metadata.columns.join(",")}`,"then","cut","-f",i,t],this.plan}if(this.stmt.columns.length>1){let i=this.stmt.columns.map(a=>{let o=a.name.replace(/[^a-zA-Z0-9]/g,"_");if(!this.catalog.metadata.columns.includes(o))throw new Error(`column ${a.name} is not in the list of columns`);return o}).join(",");return console.log("	 columns: ",i),this.plan.args=["--icsv","--ojson","--implicit-csv-header","label",`${this.catalog.metadata.columns.join(",")}`,"then","cut","-o","-f",i,t],this.plan}}return this.plan}};import l from"picocolors";import p from"picocolors";var T=`
${l.bold("Usage:")}
    muto [command] [arg] [flags]

${l.bold("Commands:")}
    query   Query data using SQL

${l.bold("Flags:")}
    -s    --source        Path to the source file ${l.bold("(required)")}
    -d    --destination   Destination of the processed file ${l.bold("(required)")}

    -i    --input         Input format ${l.bold("default: csv")} (csv, json, xml, etc.) 
    -o    --output        Output format ${l.bold("default: csv")}

    -n    --name          Name of the query ${l.bold("default: file name")}

    -v    --version       Print version
    -h    --help          Print help (what you are reading now)
  
${l.bold("Example:")} 
    muto query "select id, track from albums" -s /path/to/file.csv -d ./result.json
`,u=N({"--help":Boolean,"--version":Boolean,"--source":String,"--destination":String,"--input":String,"--output":String,"--name":String,"-h":"--help","-v":"--version","-s":"--source","-d":"--destination","-i":"--input","-o":"--output","-n":"--name"});function k(){return v(this,null,function*(){u["--help"]&&(m(T),process.exit(0)),u["--version"]&&(m("v1.0.0"),process.exit(0)),u._.length===0&&(m(p.red(`Error: Missing command, see ${l.bold("muto --help")}`)),process.exit(0)),u._.length!==2&&(m(p.red(`Error: Missing command argument, see ${l.bold("muto --help")}`)),process.exit(0)),u._[0]!=="query"&&(m(p.red(`Error: Unknown command, see ${l.bold("muto --help")}`)),process.exit(0)),u["--source"]||(m(p.red(`Error: Missing source, see ${l.bold("muto --help")}`)),process.exit(0)),u["--destination"]||(m(p.red(`Error: Missing destination, see ${l.bold("muto --help")}`)),process.exit(0));let e={input:u["--input"]||"csv",output:u["--output"]||"csv",name:u["--name"]||"first_query",source:u["--source"],destination:u["--destination"]};u._[1]===""&&(m(p.red(`Error: Missing query, see ${l.bold("muto --help")}`)),process.exit(1)),yield x(u._[1],e),process.exit(0)})}k().catch(console.error);function m(e){typeof e=="string"?process.stdout.write(`${e} 
`):process.stdout.write(`${JSON.stringify(e,null,2)} 
`)}process.on("unhandledRejection",(e,t)=>{m(e),process.exit(1)});
